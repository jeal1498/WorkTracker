<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <meta name="description" content="ControlCheck - Sistema de seguimiento de nómina y asistencia">
    <meta name="theme-color" content="#10b981">
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="./manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ControlCheck">
    <link rel="apple-touch-icon" href="./icon-192.png">
    
    <title>ControlCheck • Control de Asistencia</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#0a0a0a',
                            card: '#141414',
                            hover: '#1a1a1a',
                            border: '#262626'
                        }
                    },
                    animation: {
                        'slide-up': 'slideUp 0.3s ease-out',
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'scale-in': 'scaleIn 0.2s ease-out',
                        'slide-down': 'slideDown 0.3s ease-out',
                        'toast-in': 'toastIn 0.3s ease-out'
                    },
                    keyframes: {
                        slideUp: {
                            '0%': { transform: 'translateY(10px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        },
                        slideDown: {
                            '0%': { transform: 'translateY(-10px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        },
                        scaleIn: {
                            '0%': { transform: 'scale(0.95)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' }
                        },
                        toastIn: {
                            '0%': { transform: 'translateX(400px)', opacity: '0' },
                            '100%': { transform: 'translateX(0)', opacity: '1' }
                        }
                    }
                }
            }
        }
    </script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
        
        body { 
            -webkit-font-smoothing: antialiased;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #141414; }
        ::-webkit-scrollbar-thumb { background: #262626; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #333; }
        
        button, a, input, select, textarea, .glass-effect { 
            transition: background-color 0.15s ease, border-color 0.15s ease, color 0.15s ease, transform 0.15s ease, box-shadow 0.15s ease;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr));
            gap: 4px;
        }
        
        @media (max-width: 380px) {
            .calendar-grid {
                gap: 2px;
            }
        }
        
        .dropdown-menu {
            max-height: 320px;
            overflow-y: auto;
            animation: slideUp 0.2s ease-out;
        }
        
        .glass-effect {
            background: rgba(20, 20, 20, 0.75);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        .glass-effect-light {
            background: rgba(30, 30, 30, 0.5);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.06);
        }
        
        .card-glow {
            position: relative;
        }
        .card-glow::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: inherit;
            opacity: 0;
            transition: opacity 0.2s;
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.1);
        }
        .card-glow:hover::after {
            opacity: 1;
        }
        
        .stat-card {
            background: linear-gradient(145deg, rgba(16, 185, 129, 0.08) 0%, rgba(5, 150, 105, 0.03) 100%);
            border: 1px solid rgba(16, 185, 129, 0.15);
        }
        
        .stat-card:hover {
            background: linear-gradient(145deg, rgba(16, 185, 129, 0.14) 0%, rgba(5, 150, 105, 0.06) 100%);
            border: 1px solid rgba(16, 185, 129, 0.25);
            transform: translateY(-1px);
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.08);
        }
        
        input:focus, select:focus, textarea:focus {
            outline: 2px solid rgba(16, 185, 129, 0.5);
            outline-offset: 2px;
        }
        
        button:active {
            transform: scale(0.98);
        }
        
        .pulse-dot {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Toast Container */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            pointer-events: none;
        }
        
        .toast {
            pointer-events: auto;
            animation: toastIn 0.3s ease-out;
            margin-bottom: 10px;
        }
        
        /* Modal Backdrop */
        .modal-backdrop {
            animation: fadeIn 0.2s ease-out;
        }
        
        /* Chart Container */
        .chart-container {
            position: relative;
            height: 250px;
            width: 100%;
        }
        
        /* Fixed Neutral Palette - no dynamic theming */
        
        /* ============================================ */
        /* LIGHT MODE - Complete Override               */
        /* ============================================ */
        .light-mode {
            --bg-primary: #f8fafc;
            --bg-secondary: #f1f5f9;
            --bg-card: #ffffff;
            --bg-hover: #f1f5f9;
            --border-color: #e2e8f0;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
        }
        
        /* Body & Root */
        .light-mode,
        .light-mode body {
            background-color: var(--bg-primary) !important;
            color: var(--text-primary) !important;
        }
        
        /* --- BACKGROUNDS --- */
        .light-mode .bg-dark-bg {
            background-color: var(--bg-primary) !important;
        }
        .light-mode .bg-dark-card,
        .light-mode [class*="bg-dark-card/"] {
            background-color: var(--bg-card) !important;
        }
        .light-mode .bg-dark-hover,
        .light-mode [class*="bg-dark-hover/"] {
            background-color: var(--bg-hover) !important;
        }
        .light-mode .bg-dark-border {
            background-color: var(--border-color) !important;
        }
        
        /* --- BORDERS --- */
        .light-mode .border-dark-border,
        .light-mode [class*="border-dark-border/"] {
            border-color: var(--border-color) !important;
        }
        .light-mode .border-white\/\[0\.06\] {
            border-color: var(--border-color) !important;
        }
        .light-mode .ring-offset-dark-bg {
            --tw-ring-offset-color: var(--bg-primary) !important;
        }
        
        /* --- TEXT (general — NOT inside status-colored elements) --- */
        .light-mode .text-gray-100 { color: var(--text-primary) !important; }
        .light-mode .text-gray-400 { color: var(--text-secondary) !important; }
        .light-mode .text-gray-500 { color: var(--text-secondary) !important; }
        .light-mode .text-gray-600 { color: var(--text-muted) !important; }
        
        /* White text → dark ONLY in non-colored containers */
        .light-mode .text-white {
            color: var(--text-primary) !important;
        }
        /* KEEP white text inside colored backgrounds (status pills, gradients, buttons) */
        .light-mode .bg-emerald-500 .text-white,
        .light-mode .bg-emerald-600 .text-white,
        .light-mode .bg-blue-500 .text-white,
        .light-mode .bg-purple-500 .text-white,
        .light-mode .bg-amber-500 .text-white,
        .light-mode .bg-rose-500 .text-white,
        .light-mode .bg-red-500 .text-white,
        .light-mode [class*="bg-gradient-to"] .text-white,
        .light-mode [class*="from-emerald"] .text-white,
        .light-mode [class*="from-emerald"] .text-emerald-100,
        .light-mode [class*="from-emerald"] .text-emerald-200,
        .light-mode [class*="from-emerald"] [class*="text-white"],
        .light-mode [class*="from-emerald"] [class*="text-emerald"],
        .light-mode [class*="bg-gradient"] [class*="text-white"] {
            color: #ffffff !important;
        }
        /* Calendar day cells with status colors must keep white text */
        .light-mode .bg-emerald-500.text-white,
        .light-mode .bg-blue-500.text-white,
        .light-mode .bg-purple-500.text-white,
        .light-mode .bg-amber-500.text-white,
        .light-mode .bg-rose-500.text-white,
        .light-mode .bg-red-500.text-white {
            color: #ffffff !important;
        }
        
        /* --- ACCENT COLORS (accessible for light bg) --- */
        .light-mode .text-emerald-400 { color: #059669 !important; }
        .light-mode .text-blue-400, .light-mode .text-blue-500 { color: #2563eb !important; }
        .light-mode .text-amber-400, .light-mode .text-amber-300 { color: #b45309 !important; }
        .light-mode .text-rose-400 { color: #e11d48 !important; }
        .light-mode .text-purple-400 { color: #7c3aed !important; }
        .light-mode .text-yellow-400 { color: #a16207 !important; }
        
        /* --- GLASS EFFECT --- */
        .light-mode .glass-effect {
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(20px) !important;
            -webkit-backdrop-filter: blur(20px) !important;
            border: 1px solid rgba(0, 0, 0, 0.06) !important;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04), 0 2px 8px rgba(0, 0, 0, 0.02) !important;
        }
        
        /* --- STAT CARD --- */
        .light-mode .stat-card {
            background: linear-gradient(145deg, rgba(16, 185, 129, 0.06), rgba(5, 150, 105, 0.02)) !important;
            border: 1px solid rgba(16, 185, 129, 0.2) !important;
        }
        
        /* --- MODALS --- */
        .light-mode .bg-black\/70 {
            background: rgba(0, 0, 0, 0.3) !important;
        }
        
        /* --- FORMS --- */
        .light-mode input,
        .light-mode select,
        .light-mode textarea {
            background-color: var(--bg-hover) !important;
            border-color: var(--border-color) !important;
            color: var(--text-primary) !important;
        }
        .light-mode input::placeholder,
        .light-mode textarea::placeholder {
            color: var(--text-muted) !important;
        }
        .light-mode option {
            background-color: var(--bg-card) !important;
            color: var(--text-primary) !important;
        }
        
        /* --- NAVIGATION BAR --- */
        .light-mode nav[class*="fixed bottom-0"] {
            background: linear-gradient(to top, rgba(255,255,255,0.98), rgba(248,250,252,0.95)) !important;
            border-top-color: var(--border-color) !important;
        }
        .light-mode nav .text-gray-600 {
            color: #94a3b8 !important;
        }
        .light-mode nav .ring-dark-bg {
            --tw-ring-color: var(--bg-primary) !important;
        }

        /* --- HEADER BAR --- */
        .light-mode .bg-gradient-to-br.from-emerald-600,
        .light-mode [class*="from-emerald-600"][class*="to-emerald"] {
            background: linear-gradient(135deg, #059669, #047857) !important;
        }
        
        /* --- CALENDAR SPECIFIC --- */
        .light-mode .calendar-grid button[class*="bg-dark-card"],
        .light-mode .calendar-grid button[class*="bg-dark-hover"] {
            background-color: var(--bg-hover) !important;
            border-color: var(--border-color) !important;
        }
        .light-mode .calendar-grid button .text-gray-500 {
            color: var(--text-secondary) !important;
        }
        
        /* --- SHADOWS (softer in light mode) --- */
        .light-mode .shadow-xl {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04) !important;
        }
        .light-mode .shadow-2xl {
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.06) !important;
        }
        .light-mode .shadow-lg {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04) !important;
        }
        
        /* --- SCROLLBAR --- */
        .light-mode ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }
        .light-mode ::-webkit-scrollbar-thumb {
            background: var(--border-color);
        }
        .light-mode ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }
        
        /* --- TOAST --- */
        .light-mode .glass-effect[class*="border-emerald"],
        .light-mode .glass-effect[class*="border-rose"],
        .light-mode .glass-effect[class*="border-amber"],
        .light-mode .glass-effect[class*="border-blue"] {
            background: rgba(255, 255, 255, 0.98) !important;
        }
        
        /* --- WHITE OPACITY BACKGROUNDS (keep subtle in light) --- */
        .light-mode [class*="bg-white/"] {
            background-color: rgba(0, 0, 0, 0.04) !important;
        }
        /* But keep white/opaque inside colored headers */
        .light-mode [class*="from-emerald"] [class*="bg-white/"] {
            background-color: rgba(255, 255, 255, 0.15) !important;
        }
        
        /* Progress bar track */
        .light-mode .bg-dark-border.rounded-full {
            background-color: #e2e8f0 !important;
        }
        
        /* + button ring */
        .light-mode .ring-dark-bg {
            --tw-ring-color: var(--bg-primary) !important;
        }
    </style>
</head>
<body class="bg-dark-bg text-gray-100">
    <div id="root" role="application"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // ============================================
        // UTILIDADES DE ALMACENAMIENTO SEGURO
        // ============================================
        const safeLocalStorage = {
            getItem: (key) => {
                try {
                    return localStorage.getItem(key);
                } catch (error) {
                    console.error('Error al leer de localStorage:', error);
                    return null;
                }
            },
            setItem: (key, value) => {
                try {
                    localStorage.setItem(key, value);
                    return true;
                } catch (error) {
                    console.error('Error al escribir en localStorage:', error);
                    return false;
                }
            },
            removeItem: (key) => {
                try {
                    localStorage.removeItem(key);
                    return true;
                } catch (error) {
                    console.error('Error al eliminar de localStorage:', error);
                    return false;
                }
            }
        };

        // ============================================
        // ICONOS
        // ============================================
        const IconBase = ({ size = 24, color = "currentColor", children, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );

        const Plus = (props) => <IconBase {...props}><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>;
        const HistoryIcon = (props) => <IconBase {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12"/><path d="M3 3v9h9"/><path d="M12 7v5l3 3"/></IconBase>;
        const LayoutDashboard = (props) => <IconBase {...props}><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></IconBase>;
        const Calendar = (props) => <IconBase {...props}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></IconBase>;
        const X = (props) => <IconBase {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>;
        const FileText = (props) => <IconBase {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></IconBase>;
        const Download = (props) => <IconBase {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></IconBase>;
        const Upload = (props) => <IconBase {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></IconBase>;
        const MoreHorizontal = (props) => <IconBase {...props}><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></IconBase>;
        const Clock = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></IconBase>;
        const ChevronLeft = (props) => <IconBase {...props}><path d="m15 18-6-6 6-6"/></IconBase>;
        const ChevronRight = (props) => <IconBase {...props}><path d="m9 18 6-6-6-6"/></IconBase>;
        const ChevronDown = (props) => <IconBase {...props}><path d="m6 9 6 6 6-6"/></IconBase>;
        const Edit = (props) => <IconBase {...props}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></IconBase>;
        const TrendingUp = (props) => <IconBase {...props}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></IconBase>;
        const DollarSign = (props) => <IconBase {...props}><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></IconBase>;
        const Briefcase = (props) => <IconBase {...props}><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></IconBase>;
        const CreditCard = (props) => <IconBase {...props}><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></IconBase>;
        const AlertCircle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></IconBase>;
        const Check = (props) => <IconBase {...props}><polyline points="20 6 9 17 4 12"/></IconBase>;
        const Sparkles = (props) => <IconBase {...props}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></IconBase>;
        const Trash2 = (props) => <IconBase {...props}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>;
        const RefreshCw = (props) => <IconBase {...props}><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></IconBase>;
        const Search = (props) => <IconBase {...props}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></IconBase>;
        const BarChart3 = (props) => <IconBase {...props}><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></IconBase>;
        const Settings = (props) => <IconBase {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></IconBase>;
        const Palette = (props) => <IconBase {...props}><circle cx="13.5" cy="6.5" r=".5" fill="currentColor"/><circle cx="17.5" cy="10.5" r=".5" fill="currentColor"/><circle cx="8.5" cy="7.5" r=".5" fill="currentColor"/><circle cx="6.5" cy="12.5" r=".5" fill="currentColor"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"/></IconBase>;
        const CheckSquare = (props) => <IconBase {...props}><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></IconBase>;
        const Square = (props) => <IconBase {...props}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/></IconBase>;
        const Shield = (props) => <IconBase {...props}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></IconBase>;
        const User = (props) => <IconBase {...props}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></IconBase>;
        
        const StarFilled = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" strokeWidth="1" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" />
            </svg>
        );

        // ============================================
        // CONSTANTES
        // ============================================
        const RATES = {
            worked: 383.11,
            rest: 383.11,
            permit: 0.00,
            holiday: 1149.33,
            absent: -1149.33
        };

        const STATUS_LABELS = {
            worked: 'Trabajado',
            rest: 'Descansó',
            permit: 'Permiso',
            holiday: 'Festivo',
            absent: 'Falta'
        };

        const STATUS_COLORS = {
            worked: 'bg-emerald-500', 
            rest: 'bg-blue-500',      
            permit: 'bg-amber-500',  
            holiday: 'bg-purple-500', 
            absent: 'bg-rose-500'      
        };

        const STATUS_COLORS_LIGHT = {
            worked: 'bg-emerald-500/10', 
            rest: 'bg-blue-500/10',      
            permit: 'bg-amber-500/10',  
            holiday: 'bg-purple-500/10', 
            absent: 'bg-rose-500/10'      
        };

        const STATUS_COLORS_TEXT = {
            worked: 'text-emerald-400', 
            rest: 'text-blue-400',      
            permit: 'text-amber-400',  
            holiday: 'text-purple-400', 
            absent: 'text-rose-400'      
        };

        const HOLIDAYS_2026 = [
            { date: "2026-01-01", name: "Año Nuevo" },
            { date: "2026-02-02", name: "Día de la Constitución" },
            { date: "2026-03-16", name: "Natalicio de Benito Juárez" },
            { date: "2026-05-01", name: "Día del Trabajo" },
            { date: "2026-09-16", name: "Día de la Independencia" },
            { date: "2026-11-16", name: "Día de la Revolución" },
            { date: "2026-12-25", name: "Navidad" }
        ];

        const MONTH_NAMES_SHORT = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
        const MONTH_NAMES_FULL = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
        const DAY_NAMES = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];

        // Función para obtener saludo según la hora
        const getGreeting = () => {
            const hour = new Date().getHours();
            
            if (hour >= 6 && hour < 12) {
                return `Buenos días`;
            } else if (hour >= 12 && hour < 19) {
                return `Buenas tardes`;
            } else {
                return `Buenas noches`;
            }
        };

        // Fixed neutral gradient

        // ============================================
        // COMPONENTE TOAST
        // ============================================
        const Toast = ({ message, type = 'success', onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 4000);
                return () => clearTimeout(timer);
            }, [onClose]);

            const icons = {
                success: <Check size={20} />,
                error: <AlertCircle size={20} />,
                info: <AlertCircle size={20} />,
                warning: <AlertCircle size={20} />
            };

            const colors = {
                success: 'bg-emerald-500/20 border-emerald-500/50 text-emerald-400',
                error: 'bg-rose-500/20 border-rose-500/50 text-rose-400',
                info: 'bg-blue-500/20 border-blue-500/50 text-blue-400',
                warning: 'bg-amber-500/20 border-amber-500/50 text-amber-400'
            };

            return (
                <div className={`toast glass-effect px-5 py-3 rounded-xl shadow-2xl flex items-center gap-3 min-w-[300px] border ${colors[type]}`}>
                    {icons[type]}
                    <span className="text-sm font-semibold flex-1">{message}</span>
                    <button onClick={onClose} className="hover:opacity-70">
                        <X size={16} />
                    </button>
                </div>
            );
        };

        // ============================================
        // COMPONENTE MODAL
        // ============================================
        const Modal = ({ isOpen, onClose, onConfirm, title, message, confirmText = 'Confirmar', confirmColor = 'emerald' }) => {
            if (!isOpen) return null;

            return (
                <div className="modal-backdrop fixed inset-0 bg-black/80 backdrop-blur-sm z-[70] flex items-center justify-center p-4" onClick={onClose}>
                    <div className="glass-effect rounded-2xl shadow-2xl max-w-sm w-full animate-slide-up overflow-hidden" onClick={e => e.stopPropagation()}>
                        <div className={`p-5 bg-${confirmColor}-500/15 border-b border-${confirmColor}-500/20`}>
                            <div className="flex items-center gap-3">
                                <div className={`w-11 h-11 rounded-xl bg-${confirmColor}-500/20 flex items-center justify-center`}>
                                    <AlertCircle size={22} className={`text-${confirmColor}-400`} />
                                </div>
                                <h3 className="text-lg font-black text-white">{title}</h3>
                            </div>
                        </div>
                        <div className="p-5">
                            <p className="text-sm text-gray-400 mb-5">{message}</p>
                            <div className="flex gap-2.5">
                                <button 
                                    onClick={onClose}
                                    className="flex-1 px-4 py-3.5 bg-dark-hover border border-dark-border rounded-xl text-sm font-bold text-gray-300 hover:bg-dark-card transition-all active:scale-95"
                                >
                                    Cancelar
                                </button>
                                <button 
                                    onClick={() => {
                                        onConfirm();
                                        onClose();
                                    }}
                                    className={`flex-1 px-4 py-3.5 bg-${confirmColor}-500 rounded-xl text-sm font-black text-white hover:bg-${confirmColor}-600 transition-all active:scale-95 shadow-lg shadow-${confirmColor}-500/20`}
                                >
                                    {confirmText}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // ============================================
        // FUNCIONES DE UTILIDAD
        // ============================================
        const generatePayrollPeriods = (year) => {
            const periods = [];
            for (let month = 0; month < 12; month++) {
                const prevMonth = month === 0 ? 11 : month - 1;
                const prevYear = month === 0 ? year - 1 : year;
                
                periods.push({
                    label: `${27} ${MONTH_NAMES_SHORT[prevMonth]} - ${7} ${MONTH_NAMES_SHORT[month]}`,
                    startDate: new Date(prevYear, prevMonth, 27),
                    endDate: new Date(year, month, 7),
                    payDay: 14,
                    payMonth: month,
                    type: 'payroll'
                });
                
                periods.push({
                    label: `${8} ${MONTH_NAMES_SHORT[month]} - ${26} ${MONTH_NAMES_SHORT[month]}`,
                    startDate: new Date(year, month, 8),
                    endDate: new Date(year, month, 26),
                    payDay: 29,
                    payMonth: month,
                    type: 'payroll'
                });
            }
            return periods;
        };

        const generateCommissionPeriods = (year) => {
            // Datos reales del Calendario de Comisiones Quincenales 2026
            return [
                { label: '21 Dic - 4 Ene', quincena: 'PRIMERA', startDate: new Date(2025, 11, 21), endDate: new Date(2026, 0, 4), cutoff: '2026-01-04', comisionesDeadline: '2026-01-08', payDay: new Date(2026, 0, 15), payDayStr: '2026-01-15', days: 15, type: 'commission' },
                { label: '5 Ene - 20 Ene', quincena: 'SEGUNDA', startDate: new Date(2026, 0, 5), endDate: new Date(2026, 0, 20), cutoff: '2026-01-20', comisionesDeadline: '2026-01-23', payDay: new Date(2026, 0, 30), payDayStr: '2026-01-30', days: 16, type: 'commission' },
                { label: '21 Ene - 4 Feb', quincena: 'PRIMERA', startDate: new Date(2026, 0, 21), endDate: new Date(2026, 1, 4), cutoff: '2026-02-04', comisionesDeadline: '2026-02-10', payDay: new Date(2026, 1, 13), payDayStr: '2026-02-13', days: 15, type: 'commission' },
                { label: '5 Feb - 17 Feb', quincena: 'SEGUNDA', startDate: new Date(2026, 1, 5), endDate: new Date(2026, 1, 17), cutoff: '2026-02-17', comisionesDeadline: '2026-02-23', payDay: new Date(2026, 1, 27), payDayStr: '2026-02-27', days: 13, type: 'commission' },
                { label: '18 Feb - 4 Mar', quincena: 'PRIMERA', startDate: new Date(2026, 1, 18), endDate: new Date(2026, 2, 4), cutoff: '2026-03-04', comisionesDeadline: '2026-03-10', payDay: new Date(2026, 2, 13), payDayStr: '2026-03-13', days: 15, type: 'commission' },
                { label: '5 Mar - 20 Mar', quincena: 'SEGUNDA', startDate: new Date(2026, 2, 5), endDate: new Date(2026, 2, 20), cutoff: '2026-03-20', comisionesDeadline: '2026-03-25', payDay: new Date(2026, 2, 30), payDayStr: '2026-03-30', days: 16, type: 'commission' },
                { label: '21 Mar - 4 Abr', quincena: 'PRIMERA', startDate: new Date(2026, 2, 21), endDate: new Date(2026, 3, 4), cutoff: '2026-04-04', comisionesDeadline: '2026-04-09', payDay: new Date(2026, 3, 14), payDayStr: '2026-04-14', days: 15, type: 'commission' },
                { label: '5 Abr - 19 Abr', quincena: 'SEGUNDA', startDate: new Date(2026, 3, 5), endDate: new Date(2026, 3, 19), cutoff: '2026-04-19', comisionesDeadline: '2026-04-23', payDay: new Date(2026, 3, 29), payDayStr: '2026-04-29', days: 15, type: 'commission' },
                { label: '20 Abr - 4 May', quincena: 'PRIMERA', startDate: new Date(2026, 3, 20), endDate: new Date(2026, 4, 4), cutoff: '2026-05-04', comisionesDeadline: '2026-05-08', payDay: new Date(2026, 4, 14), payDayStr: '2026-05-14', days: 15, type: 'commission' },
                { label: '5 May - 20 May', quincena: 'SEGUNDA', startDate: new Date(2026, 4, 5), endDate: new Date(2026, 4, 20), cutoff: '2026-05-20', comisionesDeadline: '2026-05-26', payDay: new Date(2026, 4, 30), payDayStr: '2026-05-30', days: 16, type: 'commission' },
                { label: '21 May - 4 Jun', quincena: 'PRIMERA', startDate: new Date(2026, 4, 21), endDate: new Date(2026, 5, 4), cutoff: '2026-06-04', comisionesDeadline: '2026-06-09', payDay: new Date(2026, 5, 15), payDayStr: '2026-06-15', days: 15, type: 'commission' },
                { label: '5 Jun - 19 Jun', quincena: 'SEGUNDA', startDate: new Date(2026, 5, 5), endDate: new Date(2026, 5, 19), cutoff: '2026-06-19', comisionesDeadline: '2026-06-23', payDay: new Date(2026, 5, 29), payDayStr: '2026-06-29', days: 15, type: 'commission' },
                { label: '20 Jun - 4 Jul', quincena: 'PRIMERA', startDate: new Date(2026, 5, 20), endDate: new Date(2026, 6, 4), cutoff: '2026-07-04', comisionesDeadline: '2026-07-09', payDay: new Date(2026, 6, 14), payDayStr: '2026-07-14', days: 15, type: 'commission' },
                { label: '5 Jul - 20 Jul', quincena: 'SEGUNDA', startDate: new Date(2026, 6, 5), endDate: new Date(2026, 6, 20), cutoff: '2026-07-20', comisionesDeadline: '2026-07-24', payDay: new Date(2026, 6, 30), payDayStr: '2026-07-30', days: 16, type: 'commission' },
                { label: '21 Jul - 4 Ago', quincena: 'PRIMERA', startDate: new Date(2026, 6, 21), endDate: new Date(2026, 7, 4), cutoff: '2026-08-04', comisionesDeadline: '2026-08-07', payDay: new Date(2026, 7, 14), payDayStr: '2026-08-14', days: 15, type: 'commission' },
                { label: '5 Ago - 20 Ago', quincena: 'SEGUNDA', startDate: new Date(2026, 7, 5), endDate: new Date(2026, 7, 20), cutoff: '2026-08-20', comisionesDeadline: '2026-08-25', payDay: new Date(2026, 7, 31), payDayStr: '2026-08-31', days: 16, type: 'commission' },
                { label: '21 Ago - 4 Sep', quincena: 'PRIMERA', startDate: new Date(2026, 7, 21), endDate: new Date(2026, 8, 4), cutoff: '2026-09-04', comisionesDeadline: '2026-09-10', payDay: new Date(2026, 8, 14), payDayStr: '2026-09-14', days: 15, type: 'commission' },
                { label: '5 Sep - 19 Sep', quincena: 'SEGUNDA', startDate: new Date(2026, 8, 5), endDate: new Date(2026, 8, 19), cutoff: '2026-09-19', comisionesDeadline: '2026-09-24', payDay: new Date(2026, 8, 29), payDayStr: '2026-09-29', days: 15, type: 'commission' },
                { label: '20 Sep - 4 Oct', quincena: 'PRIMERA', startDate: new Date(2026, 8, 20), endDate: new Date(2026, 9, 4), cutoff: '2026-10-04', comisionesDeadline: '2026-10-08', payDay: new Date(2026, 9, 14), payDayStr: '2026-10-14', days: 15, type: 'commission' },
                { label: '5 Oct - 20 Oct', quincena: 'SEGUNDA', startDate: new Date(2026, 9, 5), endDate: new Date(2026, 9, 20), cutoff: '2026-10-20', comisionesDeadline: '2026-10-23', payDay: new Date(2026, 9, 30), payDayStr: '2026-10-30', days: 16, type: 'commission' },
                { label: '21 Oct - 4 Nov', quincena: 'PRIMERA', startDate: new Date(2026, 9, 21), endDate: new Date(2026, 10, 4), cutoff: '2026-11-04', comisionesDeadline: '2026-11-09', payDay: new Date(2026, 10, 13), payDayStr: '2026-11-13', days: 15, type: 'commission' },
                { label: '5 Nov - 19 Nov', quincena: 'SEGUNDA', startDate: new Date(2026, 10, 5), endDate: new Date(2026, 10, 19), cutoff: '2026-11-19', comisionesDeadline: '2026-11-23', payDay: new Date(2026, 10, 30), payDayStr: '2026-11-30', days: 15, type: 'commission' },
                { label: '20 Nov - 4 Dic', quincena: 'PRIMERA', startDate: new Date(2026, 10, 20), endDate: new Date(2026, 11, 4), cutoff: '2026-12-04', comisionesDeadline: '2026-12-09', payDay: new Date(2026, 11, 14), payDayStr: '2026-12-14', days: 15, type: 'commission' },
                { label: '5 Dic - 20 Dic', quincena: 'SEGUNDA', startDate: new Date(2026, 11, 5), endDate: new Date(2026, 11, 20), cutoff: '2026-12-20', comisionesDeadline: '2026-12-23', payDay: new Date(2026, 11, 30), payDayStr: '2026-12-30', days: 16, type: 'commission' }
            ];
        };

        // Validación de fechas
        const validateDate = (dateStr) => {
            if (!dateStr) return { valid: false, error: 'La fecha es requerida' };
            const date = new Date(dateStr + "T00:00:00");
            
            if (date.getFullYear() !== 2026) {
                return { valid: false, error: 'Solo se permiten fechas del año 2026' };
            }
            
            return { valid: true };
        };

        // ============================================
        // FUNCIONES DE EXPORTACIÓN
        // ============================================
        const exportToCSV = (records, selectedPeriod, includeSalary = true, includeCommissions = true, includeExpenses = true, userName = '', employeeId = '') => {
            try {
                if (!includeCommissions) {
                    // Si no incluye comisiones, usar formato tradicional
                    const headers = ['Fecha', 'Estado', 'Unidad'];
                    
                    if (includeSalary) headers.push('Salario Base');
                    if (includeExpenses) headers.push('Gastos');
                    headers.push('Total');
                    
                    const csvRows = [
                        'ControlCheck - Nomina',
                        `Nombre:,${userName || 'Sin nombre'}`,
                        `ID:,${employeeId || 'Sin ID'}`,
                        `Periodo:,${selectedPeriod}`,
                        '',
                        headers.join(',')
                    ];
                    
                    records.forEach(record => {
                        const row = [
                            record.date,
                            STATUS_LABELS[record.status],
                            record.unit || 'OFICINA'
                        ];
                        
                        if (includeSalary) row.push(record.baseSalary.toFixed(2));
                        if (includeExpenses) row.push(record.totalExp.toFixed(2));
                        
                        const total = (includeSalary ? record.baseSalary : 0) - (includeExpenses ? record.totalExp : 0);
                        row.push(total.toFixed(2));
                        
                        csvRows.push(row.join(','));
                    });
                    
                    const csvContent = csvRows.join('\n');
                    const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `ControlCheck_Nomina_${new Date().toISOString().split('T')[0]}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    return true;
                }
                
                // FORMATO NUEVO PARA COMISIONES (según imagen)
                const exportDate = new Date().toLocaleDateString('es-MX', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                
                // Calcular totales
                let totalComisiones = 0;
                let foliosCount = 0;
                
                // Crear filas con cada comisión individual
                const dataRows = [];
                records.forEach(record => {
                    if (record.commissions && record.commissions.length > 0) {
                        record.commissions.forEach(comm => {
                            if (comm.amount && parseFloat(comm.amount) > 0) {
                                dataRows.push({
                                    fecha: new Date(record.date + "T00:00:00").toLocaleDateString('es-MX'),
                                    unidad: record.unit || 'OFICINA',
                                    folio: comm.folio || record.id || 'N/A',
                                    concepto: comm.name || 'Comisión',
                                    comision: parseFloat(comm.amount)
                                });
                                totalComisiones += parseFloat(comm.amount);
                                foliosCount++;
                            }
                        });
                    }
                });
                
                // Construir CSV
                const csvLines = [];
                csvLines.push('ControlCheck');
                csvLines.push(`Fecha:,${exportDate}`);
                csvLines.push('');
                csvLines.push(`Nombre:,${userName || 'Sin nombre'}`);
                csvLines.push(`ID:,${employeeId || 'Sin ID'}`);
                csvLines.push(`Periodo:,${selectedPeriod}`);
                csvLines.push(`Registros:,${foliosCount}`);
                csvLines.push(`Total:,$${totalComisiones.toFixed(2)}`);
                csvLines.push('');
                csvLines.push('Fecha,Unidad,ID,Concepto,Comisión');
                
                dataRows.forEach(row => {
                    csvLines.push(`${row.fecha},${row.unidad},${row.folio},${row.concepto},$${row.comision.toFixed(2)}`);
                });
                
                const csvContent = csvLines.join('\n');
                const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `ControlCheck_Comisiones_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                return true;
            } catch (error) {
                console.error('Error al exportar CSV:', error);
                return false;
            }
        };

        const exportToPDF = (records, totals, selectedPeriod, includeSalary = true, includeCommissions = true, includeExpenses = true, userName = '', employeeId = '') => {
            try {
                if (!includeCommissions) {
                    // Formato tradicional para nómina
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    doc.setFontSize(20);
                    doc.setFont(undefined, 'bold');
                    doc.text('ControlCheck - Nómina', 105, 20, { align: 'center' });
                    
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    doc.text(`Fecha: ${new Date().toLocaleDateString('es-MX')}`, 105, 28, { align: 'center' });
                    doc.text(`${userName || 'Sin nombre'} | #${employeeId || 'Sin ID'}`, 105, 34, { align: 'center' });
                    
                    const headers = ['Fecha', 'Estado', 'Unidad'];
                    if (includeSalary) headers.push('Salario');
                    if (includeExpenses) headers.push('Gastos');
                    headers.push('Total');
                    
                    const tableData = records.map(record => {
                        const row = [
                            new Date(record.date + "T00:00:00").toLocaleDateString('es-MX'),
                            STATUS_LABELS[record.status],
                            record.unit || 'OFICINA'
                        ];
                        
                        if (includeSalary) row.push(`$${record.baseSalary.toFixed(2)}`);
                        if (includeExpenses) row.push(`$${record.totalExp.toFixed(2)}`);
                        
                        const total = (includeSalary ? record.baseSalary : 0) - (includeExpenses ? record.totalExp : 0);
                        row.push(`$${total.toFixed(2)}`);
                        
                        return row;
                    });
                    
                    doc.autoTable({
                        head: [headers],
                        body: tableData,
                        startY: 40,
                        theme: 'grid',
                        headStyles: { fillColor: [16, 185, 129] },
                        styles: { fontSize: 8 }
                    });
                    
                    doc.save(`ControlCheck_Nomina_${new Date().toISOString().split('T')[0]}.pdf`);
                    return true;
                }
                
                // FORMATO NUEVO PARA COMISIONES (según imagen)
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const exportDate = new Date().toLocaleDateString('es-MX', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                
                // Título
                doc.setFontSize(24);
                doc.setFont(undefined, 'bold');
                doc.text('ControlCheck', 105, 20, { align: 'center' });
                
                // Fecha de exportación
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`Fecha: ${exportDate}`, 105, 28, { align: 'center' });
                
                // Información del empleado
                let yPos = 40;
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.text('Nombre:', 20, yPos);
                doc.setFont(undefined, 'normal');
                doc.text(userName || 'Sin nombre', 50, yPos);
                
                yPos += 7;
                doc.setFont(undefined, 'bold');
                doc.text('ID:', 20, yPos);
                doc.setFont(undefined, 'normal');
                doc.text(employeeId || 'Sin ID', 50, yPos);
                
                yPos += 7;
                doc.setFont(undefined, 'bold');
                doc.text('Periodo:', 20, yPos);
                doc.setFont(undefined, 'normal');
                doc.text(selectedPeriod, 50, yPos);
                
                // Calcular totales
                let totalComisiones = 0;
                let foliosCount = 0;
                const dataRows = [];
                
                records.forEach(record => {
                    if (record.commissions && record.commissions.length > 0) {
                        record.commissions.forEach(comm => {
                            if (comm.amount && parseFloat(comm.amount) > 0) {
                                dataRows.push([
                                    new Date(record.date + "T00:00:00").toLocaleDateString('es-MX'),
                                    record.unit || 'OFICINA',
                                    comm.folio || record.id || 'N/A',
                                    comm.name || 'Comisión',
                                    `$${parseFloat(comm.amount).toFixed(2)}`
                                ]);
                                totalComisiones += parseFloat(comm.amount);
                                foliosCount++;
                            }
                        });
                    }
                });
                
                yPos += 7;
                doc.setFont(undefined, 'bold');
                doc.text('Registros:', 20, yPos);
                doc.setFont(undefined, 'normal');
                doc.text(foliosCount.toString(), 50, yPos);
                
                yPos += 7;
                doc.setFont(undefined, 'bold');
                doc.text('Total:', 20, yPos);
                doc.setFont(undefined, 'normal');
                doc.text(`$${totalComisiones.toFixed(2)}`, 50, yPos);
                
                // Tabla de comisiones
                yPos += 10;
                doc.autoTable({
                    head: [['Fecha', 'Unidad', 'ID', 'Concepto', 'Comisión']],
                    body: dataRows,
                    startY: yPos,
                    theme: 'grid',
                    headStyles: { 
                        fillColor: [16, 185, 129],
                        fontStyle: 'bold',
                        halign: 'center'
                    },
                    styles: { 
                        fontSize: 9,
                        cellPadding: 3
                    },
                    columnStyles: {
                        0: { halign: 'center' },
                        1: { halign: 'center' },
                        2: { halign: 'center' },
                        3: { halign: 'left' },
                        4: { halign: 'right' }
                    }
                });
                
                doc.save(`ControlCheck_Comisiones_${new Date().toISOString().split('T')[0]}.pdf`);
                return true;
            } catch (error) {
                console.error('Error al exportar PDF:', error);
                return false;
            }
        };

        // ============================================
        // FUNCIONES DE RESPALDO
        // ============================================
        const exportBackup = (records) => {
            try {
                const backup = {
                    version: '2.0',
                    exportDate: new Date().toISOString(),
                    records: records,
                    metadata: {
                        totalRecords: records.length,
                        appName: 'WorkTracker Pro'
                    }
                };
                
                const dataStr = JSON.stringify(backup, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `WorkTracker_Backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                return true;
            } catch (error) {
                console.error('Error al exportar respaldo:', error);
                return false;
            }
        };

        const importBackup = (file, setRecords, showToast) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const backup = JSON.parse(e.target.result);
                    
                    // Validar estructura del backup
                    if (!backup.records || !Array.isArray(backup.records)) {
                        showToast('Archivo de respaldo inválido', 'error');
                        return;
                    }
                    
                    // Restaurar datos
                    setRecords(backup.records);
                    safeLocalStorage.setItem('worktracker_records', JSON.stringify(backup.records));
                    showToast(`✓ ${backup.records.length} registros restaurados exitosamente`, 'success');
                } catch (error) {
                    console.error('Error al importar respaldo:', error);
                    showToast('Error al procesar el archivo de respaldo', 'error');
                }
            };
            reader.readAsText(file);
        };

        // ============================================
        // COMPONENTE PRINCIPAL
        // ============================================
        const App = () => {
            const [records, setRecords] = useState([]);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [returnTab, setReturnTab] = useState('dashboard'); // Tab to return to after form closes
            const [editingId, setEditingId] = useState(null);
            
            const [filterStartDate, setFilterStartDate] = useState('');
            const [filterEndDate, setFilterEndDate] = useState('');
            const [filterStatuses, setFilterStatuses] = useState(['all']);
            const [searchQuery, setSearchQuery] = useState('');
            const [showHistoryFilters, setShowHistoryFilters] = useState(false);
            
            const [selectedPeriod, setSelectedPeriod] = useState(() => {
                // Auto-detectar periodo de comisión actual
                const now = new Date();
                const periods = generateCommissionPeriods(2026);
                const current = periods.find(p => now >= p.startDate && now <= p.endDate);
                return current ? current.label : 'custom';
            });
            const payrollPeriods = useMemo(() => generatePayrollPeriods(2026), []);
            const commissionPeriods = useMemo(() => generateCommissionPeriods(2026), []);
            
            // Periods available directly as payrollPeriods and commissionPeriods
            
            const [viewMode, setViewMode] = useState('calendar');
            const [currentMonth, setCurrentMonth] = useState(new Date().getMonth());
            const [currentYear, setCurrentYear] = useState(2026);
            
            const [showMonthDropdown, setShowMonthDropdown] = useState(false);
            
            const [toasts, setToasts] = useState([]);
            const [modalState, setModalState] = useState({ isOpen: false, type: null, data: null });
            
            // Theme removed
            const [selectedRecords, setSelectedRecords] = useState([]);
            const [isMultiSelectMode, setIsMultiSelectMode] = useState(false);
            
            // Estados para perfil de usuario
            const [userName, setUserName] = useState(() => safeLocalStorage.getItem('worktracker_userName') || '');
            const [employeeId, setEmployeeId] = useState(() => safeLocalStorage.getItem('worktracker_employeeId') || '');
            const [showUserProfile, setShowUserProfile] = useState(false);
            
            // Estados para exportación
            const [exportSalary, setExportSalary] = useState(true);
            const [exportCommissions, setExportCommissions] = useState(true);
            const [exportExpenses, setExportExpenses] = useState(true);
            
            // Estado para configuración de tarifas
            const [showRatesConfig, setShowRatesConfig] = useState(false);
            const [customRates, setCustomRates] = useState(null);
            
            // Estados para modal de configuración (antes "Más")
            // Settings modal removed
            const [showBackupModal, setShowBackupModal] = useState(false);
            
            // Estado para selector de periodo de exportación
            const [showExportPeriodModal, setShowExportPeriodModal] = useState(false);
            const [exportSelectedPeriod, setExportSelectedPeriod] = useState('current'); // 'current' or period label
            const [exportPeriodSelection, setExportPeriodSelection] = useState('all');
            const [pendingExportType, setPendingExportType] = useState(null); // 'pdf' o 'csv'
            
            // Estado para mostrar periodos anteriores
            const [showPastPeriods, setShowPastPeriods] = useState(false);
            
            // Estados para filtros rápidos de historial
            const [filterCommissionsOnly, setFilterCommissionsOnly] = useState(false);
            const [filterExpensesOnly, setFilterExpensesOnly] = useState(false);
            
            // Estado para selector de periodo en dashboard
            // periodTabType kept for History filters
            const [periodTabType, setPeriodTabType] = useState('payroll'); // 'payroll' | 'commission'
            
            // Estado para modal de comisiones preconfiguradas con QR
            const [showCommissionsModal, setShowCommissionsModal] = useState(false);
            const [preconfFilter, setPreconfFilter] = useState('Desde Aeropuerto Cancún');
            const [showQRModal, setShowQRModal] = useState(false); // Modal de registro de jornada
            const [showQRConfigModal, setShowQRConfigModal] = useState(false); // Modal para configurar QR (solo en perfil)
            const [showQuickCommissionModal, setShowQuickCommissionModal] = useState(false); // Modal de comisión rápida
            const [selectedUnitType, setSelectedUnitType] = useState(''); // '' por defecto para forzar selección
            const [selectedCategory, setSelectedCategory] = useState('Desde Aeropuerto Cancún');
            const [selectedQRCategory, setSelectedQRCategory] = useState('Desde Aeropuerto Cancún');
            const [selectedQRUnitType, setSelectedQRUnitType] = useState('crafter');
            const [qrImage, setQRImage] = useState(safeLocalStorage.getItem('worktracker_qrImage') || '');
            const qrCodeRef = React.useRef(null);
            
            // Estado para modal de detalle del día (calendario)
            const [showDayDetailModal, setShowDayDetailModal] = useState(false);
            const [selectedDayRecord, setSelectedDayRecord] = useState(null);
            
            // Estado para nombre específico de unidad (ej: UV07)
            const [unitIdentifier, setUnitIdentifier] = useState('');
            
            // Estado para confirmación de comisión
            const [pendingCommission, setPendingCommission] = useState(null); // {name, amount, context: 'quick'|'qrmodal'|'frequent'}
            const [targetRecordDate, setTargetRecordDate] = useState(null); // Date string of the record to add commissions to (null = today)
            
            // Estados para mejoras de UX
            const [isLoading, setIsLoading] = useState(false);
            const [loadingMessage, setLoadingMessage] = useState('');
            const [isOnline, setIsOnline] = useState(navigator.onLine);
            const [hasSeenOnboarding, setHasSeenOnboarding] = useState(
                () => safeLocalStorage.getItem('onboarding_completed') === 'true'
            );
            const [showOnboarding, setShowOnboarding] = useState(false);
            const [onboardingStep, setOnboardingStep] = useState(0);
            
            // Estados para metas y dashboard personalizado
            const [weeklyGoal, setWeeklyGoal] = useState(
                () => parseFloat(safeLocalStorage.getItem('weekly_goal')) || 5000
            );
            const [monthlyHoursGoal, setMonthlyHoursGoal] = useState(
                () => parseFloat(safeLocalStorage.getItem('monthly_hours_goal')) || 180
            );
            const [showGoalsModal, setShowGoalsModal] = useState(false);
            
            // Comisiones preconfiguradas basadas en las tablas oficiales
            const presetCommissions = {
                'Desde Aeropuerto Cancún': {
                    'Playa Mujeres / Costa Mujeres (Crafter/Sprinter/Transporter/Urvan)': 80,
                    'Playa Mujeres / Costa Mujeres (Limosina/Suburban/Navigator)': 120,
                    'Playa Mujeres / Costa Mujeres (Autobús)': 120,
                    'Zona Hotelera Cancún (Crafter/Sprinter/Transporter/Urvan)': 60,
                    'Zona Hotelera Cancún (Limosina/Suburban/Navigator)': 100,
                    'Zona Hotelera Cancún (Autobús)': 100,
                    'Cancún Centro (Crafter/Sprinter/Transporter/Urvan)': 60,
                    'Cancún Centro (Limosina/Suburban/Navigator)': 100,
                    'Cancún Centro (Autobús)': 100,
                    'Puerto Morelos (Crafter/Sprinter/Transporter/Urvan)': 60,
                    'Puerto Morelos (Limosina/Suburban/Navigator)': 100,
                    'Puerto Morelos (Autobús)': 100,
                    'Playa del Carmen (Crafter/Sprinter/Transporter/Urvan)': 80,
                    'Playa del Carmen (Limosina/Suburban/Navigator)': 120,
                    'Playa del Carmen (Autobús)': 120,
                    'Puerto Aventuras (Crafter/Sprinter/Transporter/Urvan)': 100,
                    'Puerto Aventuras (Limosina/Suburban/Navigator)': 140,
                    'Puerto Aventuras (Autobús)': 140,
                    'Akumal (Crafter/Sprinter/Transporter/Urvan)': 100,
                    'Akumal (Limosina/Suburban/Navigator)': 140,
                    'Akumal (Autobús)': 140,
                    'Tulúm (Crafter/Sprinter/Transporter/Urvan)': 120,
                    'Tulúm (Limosina/Suburban/Navigator)': 150,
                    'Tulúm (Autobús)': 150,
                },
                'Desde Aeropuerto Tulúm': {
                    'Tulúm (Crafter/Sprinter/Transporter/Urvan)': 80,
                    'Tulúm (Limosina/Suburban/Navigator)': 120,
                    'Tulúm (Autobús)': 120,
                    'Akumal (Crafter/Sprinter/Transporter/Urvan)': 100,
                    'Akumal (Limosina/Suburban/Navigator)': 140,
                    'Akumal (Autobús)': 180,
                    'Puerto Aventuras (Crafter/Sprinter/Transporter/Urvan)': 100,
                    'Puerto Aventuras (Limosina/Suburban/Navigator)': 140,
                    'Puerto Aventuras (Autobús)': 180,
                    'Playa del Carmen (Crafter/Sprinter/Transporter/Urvan)': 120,
                    'Playa del Carmen (Limosina/Suburban/Navigator)': 160,
                    'Playa del Carmen (Autobús)': 200,
                    'Puerto Morelos (Crafter/Sprinter/Transporter/Urvan)': 140,
                    'Puerto Morelos (Limosina/Suburban/Navigator)': 180,
                    'Puerto Morelos (Autobús)': 220,
                    'Cancún Centro (Crafter/Sprinter/Transporter/Urvan)': 160,
                    'Cancún Centro (Limosina/Suburban/Navigator)': 200,
                    'Cancún Centro (Autobús)': 240,
                    'Zona Hotelera Cancún (Crafter/Sprinter/Transporter/Urvan)': 160,
                    'Zona Hotelera Cancún (Limosina/Suburban/Navigator)': 200,
                    'Zona Hotelera Cancún (Autobús)': 240,
                    'Playa Mujeres / Costa Mujeres (Crafter/Sprinter/Transporter/Urvan)': 180,
                    'Playa Mujeres / Costa Mujeres (Limosina/Suburban/Navigator)': 220,
                    'Playa Mujeres / Costa Mujeres (Autobús)': 260,
                },
                'Punto a Punto': {
                    // Desde Playa Mujeres / Costa Mujeres
                    'Playa Mujeres → ZH Cancún / Cancún Centro / Pto. Morelos (Crafter/Sprinter/Transporter/Urvan)': 60,
                    'Playa Mujeres → ZH Cancún / Cancún Centro / Pto. Morelos (Limosina/Suburban/Navigator)': 78,
                    'Playa Mujeres → Playa Carmen (Crafter/Sprinter/Transporter/Urvan)': 100,
                    'Playa Mujeres → Playa Carmen (Limosina/Suburban/Navigator)': 130,
                    'Playa Mujeres → Pto Aventuras / Akumal (Crafter/Sprinter/Transporter/Urvan)': 120,
                    'Playa Mujeres → Pto Aventuras / Akumal (Limosina/Suburban/Navigator)': 156,
                    'Playa Mujeres → Tulum (Crafter/Sprinter/Transporter/Urvan)': 140,
                    'Playa Mujeres → Tulum (Limosina/Suburban/Navigator)': 182,
                    // Desde ZH Cancún / Cancún Centro / Pto. Morelos
                    'ZH Cancún / Cancún Centro / Pto. Morelos → Playa Mujeres (Crafter/Sprinter/Transporter/Urvan)': 60,
                    'ZH Cancún / Cancún Centro / Pto. Morelos → Playa Mujeres (Limosina/Suburban/Navigator)': 78,
                    'ZH Cancún / Cancún Centro / Pto. Morelos → Playa Carmen (Crafter/Sprinter/Transporter/Urvan)': 80,
                    'ZH Cancún / Cancún Centro / Pto. Morelos → Playa Carmen (Limosina/Suburban/Navigator)': 104,
                    'ZH Cancún / Cancún Centro / Pto. Morelos → Pto Aventuras / Akumal (Crafter/Sprinter/Transporter/Urvan)': 100,
                    'ZH Cancún / Cancún Centro / Pto. Morelos → Pto Aventuras / Akumal (Limosina/Suburban/Navigator)': 130,
                    'ZH Cancún / Cancún Centro / Pto. Morelos → Tulum (Crafter/Sprinter/Transporter/Urvan)': 120,
                    'ZH Cancún / Cancún Centro / Pto. Morelos → Tulum (Limosina/Suburban/Navigator)': 156,
                    // Desde Playa del Carmen
                    'Playa Carmen → Playa Mujeres (Crafter/Sprinter/Transporter/Urvan)': 100,
                    'Playa Carmen → Playa Mujeres (Limosina/Suburban/Navigator)': 130,
                    'Playa Carmen → ZH Cancún / Cancún Centro / Pto. Morelos (Crafter/Sprinter/Transporter/Urvan)': 80,
                    'Playa Carmen → ZH Cancún / Cancún Centro / Pto. Morelos (Limosina/Suburban/Navigator)': 104,
                    'Playa Carmen → Pto Aventuras / Akumal (Crafter/Sprinter/Transporter/Urvan)': 100,
                    'Playa Carmen → Pto Aventuras / Akumal (Limosina/Suburban/Navigator)': 130,
                    'Playa Carmen → Tulum (Crafter/Sprinter/Transporter/Urvan)': 120,
                    'Playa Carmen → Tulum (Limosina/Suburban/Navigator)': 156,
                    // Desde Pto. Aventuras / Akumal
                    'Pto Aventuras / Akumal → Playa Mujeres (Crafter/Sprinter/Transporter/Urvan)': 120,
                    'Pto Aventuras / Akumal → Playa Mujeres (Limosina/Suburban/Navigator)': 156,
                    'Pto Aventuras / Akumal → ZH Cancún / Cancún Centro / Pto. Morelos (Crafter/Sprinter/Transporter/Urvan)': 100,
                    'Pto Aventuras / Akumal → ZH Cancún / Cancún Centro / Pto. Morelos (Limosina/Suburban/Navigator)': 130,
                    'Pto Aventuras / Akumal → Playa Carmen (Crafter/Sprinter/Transporter/Urvan)': 100,
                    'Pto Aventuras / Akumal → Playa Carmen (Limosina/Suburban/Navigator)': 130,
                    'Pto Aventuras / Akumal → Tulum (Crafter/Sprinter/Transporter/Urvan)': 100,
                    'Pto Aventuras / Akumal → Tulum (Limosina/Suburban/Navigator)': 130,
                    // Desde Tulum
                    'Tulum → Playa Mujeres (Crafter/Sprinter/Transporter/Urvan)': 140,
                    'Tulum → Playa Mujeres (Limosina/Suburban/Navigator)': 182,
                    'Tulum → ZH Cancún / Cancún Centro / Pto. Morelos (Crafter/Sprinter/Transporter/Urvan)': 120,
                    'Tulum → ZH Cancún / Cancún Centro / Pto. Morelos (Limosina/Suburban/Navigator)': 156,
                    'Tulum → Playa Carmen (Crafter/Sprinter/Transporter/Urvan)': 120,
                    'Tulum → Playa Carmen (Limosina/Suburban/Navigator)': 156,
                    'Tulum → Pto Aventuras / Akumal (Crafter/Sprinter/Transporter/Urvan)': 100,
                    'Tulum → Pto Aventuras / Akumal (Limosina/Suburban/Navigator)': 130,
                },
                'Servicios Especiales': {
                    'Abierto por Hora (Crafter/Sprinter/Transporter/Urvan)': 50,
                    'Abierto por Hora (Limosina/Suburban/Navigator)': 65,
                    'Abierto por Hora (Autobús)': 65,
                    'Personal Local (Crafter/Sprinter/Transporter/Urvan)': 40,
                    'Personal Local (Autobús)': 60,
                    'Personal Playa (Crafter/Sprinter/Transporter/Urvan)': 60,
                    'Personal Playa (Autobús)': 90,
                    'Personal Corredor (Crafter/Sprinter/Transporter/Urvan)': 80,
                    'Personal Corredor (Autobús)': 120,
                }
            };
            
            // Función para filtrar comisiones por tipo de unidad
            const getFilteredCommissions = (unitType) => {
                if (unitType === 'all') return presetCommissions;
                
                const filtered = {};
                
                Object.entries(presetCommissions).forEach(([category, commissions]) => {
                    const filteredCommissions = {};
                    
                    Object.entries(commissions).forEach(([name, amount]) => {
                        const nameLower = name.toLowerCase();
                        
                        if (unitType === 'crafter') {
                            if (nameLower.includes('crafter') || nameLower.includes('transporter') || nameLower.includes('sprinter') || nameLower.includes('urvan')) {
                                filteredCommissions[name] = amount;
                            }
                        } else if (unitType === 'navigator') {
                            if (nameLower.includes('navigator') || nameLower.includes('suburban') || nameLower.includes('limosina')) {
                                filteredCommissions[name] = amount;
                            }
                        } else if (unitType === 'autobus') {
                            if (nameLower.includes('autobús') || nameLower.includes('bus')) {
                                filteredCommissions[name] = amount;
                            }
                        }
                    });
                    
                    if (Object.keys(filteredCommissions).length > 0) {
                        filtered[category] = filteredCommissions;
                    }
                });
                
                return filtered;
            };
            
            // Función para filtrar comisiones por categoría Y tipo de unidad (para el modal de QR)
            const getFilteredCommissionsByCategory = (category, unitType) => {
                if (!presetCommissions[category]) return {};
                
                const commissions = presetCommissions[category];
                
                if (unitType === 'all') return commissions;
                
                const filtered = {};
                
                Object.entries(commissions).forEach(([name, amount]) => {
                    const nameLower = name.toLowerCase();
                    
                    if (unitType === 'crafter') {
                        if (nameLower.includes('crafter') || nameLower.includes('transporter') || nameLower.includes('sprinter') || nameLower.includes('urvan')) {
                            filtered[name] = amount;
                        }
                    } else if (unitType === 'navigator') {
                        if (nameLower.includes('navigator') || nameLower.includes('suburban') || nameLower.includes('limosina')) {
                            filtered[name] = amount;
                        }
                    } else if (unitType === 'autobus') {
                        if (nameLower.includes('autobús') || nameLower.includes('bus')) {
                            filtered[name] = amount;
                        }
                    }
                });
                
                return filtered;
            };
            
            // Efecto para generar el código QR cuando se abre el modal - DESHABILITADO: Ahora se usa imagen subida por el usuario
            /*
            useEffect(() => {
                if (showQRModal && qrCodeRef.current) {
                    // Limpiar QR anterior
                    qrCodeRef.current.innerHTML = '';
                    
                    // Generar nuevo QR
                    const qrData = `ControlCheck - Comisiones\nCategoría: ${selectedCategory}\nTipo de Unidad: ${
                        selectedUnitType === 'all' ? 'Todas' :
                        selectedUnitType === 'crafter' ? 'Crafter/Sprinter/Transporter/Urvan' :
                        selectedUnitType === 'navigator' ? 'Limosina/Suburban/Navigator' :
                        'Autobús'
                    }`;
                    
                    new QRCode(qrCodeRef.current, {
                        text: qrData,
                        width: 200,
                        height: 200,
                        colorDark: '#10b981',
                        colorLight: '#ffffff',
                        correctLevel: QRCode.CorrectLevel.H
                    });
                }
            }, [showQRModal, selectedCategory, selectedUnitType]);
            */
            
            // Estado para modo de tema del sistema
            const [systemThemeMode, setSystemThemeMode] = useState(() => {
                try {
                    return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
                } catch(e) { return 'dark'; }
            });

            const initialFormData = {
                date: '',
                status: 'worked',
                unit: '',
                startTime: '',
                endTime: '',
                commissions: [],
                expenses: [],
                description: ''
            };
            const [formData, setFormData] = useState(initialFormData);

            const fileInputRef = useRef(null);

            // Cargar datos al iniciar
            useEffect(() => {
                try {
                    const savedRecords = safeLocalStorage.getItem('worktracker_records');
                    if (savedRecords) {
                        setRecords(JSON.parse(savedRecords));
                    }
                    
                    // Theme fixed
                    
                    const savedRates = safeLocalStorage.getItem('worktracker_rates');
                    if (savedRates) {
                        setCustomRates(JSON.parse(savedRates));
                    }
                    
                    // Detectar tema del sistema
                    const darkModeQuery = window.matchMedia('(prefers-color-scheme: dark)');
                    setSystemThemeMode(darkModeQuery.matches ? 'dark' : 'light');
                    
                    // Escuchar cambios en el tema del sistema
                    const handleThemeChange = (e) => {
                        setSystemThemeMode(e.matches ? 'dark' : 'light');
                    };
                    
                    darkModeQuery.addEventListener('change', handleThemeChange);
                    
                    return () => darkModeQuery.removeEventListener('change', handleThemeChange);
                } catch (error) {
                    console.error('Error al cargar datos:', error);
                    showToast('Error al cargar los datos guardados', 'error');
                }
            }, []);

            // Guardar datos cuando cambian
            useEffect(() => {
                if (records.length > 0) {
                    safeLocalStorage.setItem('worktracker_records', JSON.stringify(records));
                }
            }, [records]);
            
            // MEJORA #13: Detectar estado de red (online/offline)
            useEffect(() => {
                const handleOnline = () => {
                    setIsOnline(true);
                    showToast('📡 Conexión restaurada', 'success');
                };
                
                const handleOffline = () => {
                    setIsOnline(false);
                    showToast('📡 Modo offline activado - Los cambios se guardan localmente', 'info');
                };
                
                window.addEventListener('online', handleOnline);
                window.addEventListener('offline', handleOffline);
                
                return () => {
                    window.removeEventListener('online', handleOnline);
                    window.removeEventListener('offline', handleOffline);
                };
            }, []);
            
            // MEJORA #5: Cerrar modal rápido automáticamente si se borra el registro del día
            useEffect(() => {
                if (showQuickCommissionModal) {
                    const dateToCheck = targetRecordDate || new Date().toISOString().split('T')[0];
                    const dateRecord = records.find(r => r.date === dateToCheck);
                    
                    if (!dateRecord) {
                        setShowQuickCommissionModal(false);
                        showToast('El registro del día fue eliminado', 'info');
                    }
                }
            }, [records, showQuickCommissionModal, targetRecordDate]);
            
            // MEJORA #11: Mostrar onboarding para nuevos usuarios
            useEffect(() => {
                if (!hasSeenOnboarding && records.length === 0 && !qrImage) {
                    // Esperar 1 segundo para que cargue la UI
                    const timer = setTimeout(() => {
                        setShowOnboarding(true);
                    }, 1000);
                    
                    return () => clearTimeout(timer);
                }
            }, [hasSeenOnboarding, records.length, qrImage]);
            
            // Guardar metas cuando cambian
            useEffect(() => {
                safeLocalStorage.setItem('weekly_goal', weeklyGoal.toString());
            }, [weeklyGoal]);
            
            useEffect(() => {
                safeLocalStorage.setItem('monthly_hours_goal', monthlyHoursGoal.toString());
            }, [monthlyHoursGoal]);

            // Guardar y aplicar tema
            useEffect(() => {
                // Theme fixed
                
                // Aplicar modo del sistema
                const modeClass = systemThemeMode === 'light' ? 'light-mode' : 'dark-mode';
                document.documentElement.className = modeClass;
                
                // Aplicar color del tema a todo el documento
                const themeColor = '#10b981';
                document.documentElement.style.setProperty('--theme-color', themeColor);
                
                // Cambiar meta theme-color para navegador
                const metaTheme = document.querySelector('meta[name="theme-color"]');
                if (metaTheme) {
                    metaTheme.setAttribute('content', themeColor);
                }
            }, [systemThemeMode]);

            // Toast helper
            const showToast = (message, type = 'success') => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, message, type }]);
            };

            const removeToast = (id) => {
                setToasts(prev => prev.filter(t => t.id !== id));
            };

            // Obtener tarifas actuales (personalizadas o por defecto)
            const getCurrentRates = () => {
                return customRates || RATES;
            };

            // Guardar tarifas personalizadas
            const saveCustomRates = (newRates) => {
                setCustomRates(newRates);
                safeLocalStorage.setItem('worktracker_rates', JSON.stringify(newRates));
                showToast('✓ Tarifas actualizadas correctamente', 'success');
            };

            // Manejar carga de imagen QR
            const handleQRImageUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    // Verificar que sea una imagen
                    if (!file.type.startsWith('image/')) {
                        showToast('Por favor selecciona una imagen', 'error');
                        return;
                    }
                    
                    // Leer la imagen como base64
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        const base64String = reader.result;
                        setQRImage(base64String);
                        safeLocalStorage.setItem('worktracker_qrImage', base64String);
                        showToast('✓ Código QR guardado', 'success');
                    };
                    reader.readAsDataURL(file);
                }
            };

            // Eliminar imagen QR
            const removeQRImage = () => {
                setQRImage('');
                safeLocalStorage.removeItem('worktracker_qrImage');
                showToast('Código QR eliminado', 'info');
            };
            
            // MEJORA #2: Validación avanzada de horarios
            const validateWorkHours = (startTime, endTime) => {
                if (!startTime || !endTime) {
                    return { valid: false, error: 'Debes ingresar hora de inicio y fin' };
                }
                
                const start = new Date(`2000-01-01T${startTime}`);
                const end = new Date(`2000-01-01T${endTime}`);
                
                let hoursWorked = (end - start) / (1000 * 60 * 60);
                
                // Si es negativo, cruza medianoche
                if (hoursWorked < 0) {
                    hoursWorked += 24;
                }
                
                // Validar jornada razonable
                if (hoursWorked < 0.5) {
                    return { valid: false, error: 'La jornada debe ser de al menos 30 minutos' };
                }
                
                if (hoursWorked > 16) {
                    return { valid: false, error: 'La jornada no puede exceder 16 horas. Verifica los horarios.' };
                }
                
                return { valid: true, hoursWorked };
            };
            
            // MEJORA #12: Obtener comisiones más frecuentes del usuario
            const getFrequentCommissions = () => {
                const commissionCounts = {};
                
                records.forEach(record => {
                    record.commissions?.forEach(comm => {
                        commissionCounts[comm.name] = (commissionCounts[comm.name] || 0) + 1;
                    });
                });
                
                return Object.entries(commissionCounts)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 5)
                    .map(([name, count]) => ({ name, count }));
            };
            
            // MEJORA #14: Calcular progreso de metas
            const getWeeklyProgress = () => {
                const now = new Date();
                const startOfWeek = new Date(now);
                startOfWeek.setDate(now.getDate() - now.getDay()); // Domingo
                startOfWeek.setHours(0, 0, 0, 0);
                
                const weekRecords = records.filter(r => {
                    const recordDate = new Date(r.date + 'T00:00:00');
                    return recordDate >= startOfWeek;
                });
                
                const weeklyTotal = weekRecords.reduce((sum, r) => sum + (r.totalComm || 0), 0);
                const progress = weeklyGoal > 0 ? (weeklyTotal / weeklyGoal) * 100 : 0;
                
                return { weeklyTotal, progress: Math.min(progress, 100), weekRecords };
            };
            
            const getMonthlyProgress = () => {
                const now = new Date();
                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                
                const monthRecords = records.filter(r => {
                    const recordDate = new Date(r.date + 'T00:00:00');
                    return recordDate >= startOfMonth;
                });
                
                const monthlyHours = monthRecords.reduce((sum, r) => sum + (r.hoursWorked || 0), 0);
                const progress = monthlyHoursGoal > 0 ? (monthlyHours / monthlyHoursGoal) * 100 : 0;
                
                return { monthlyHours, progress: Math.min(progress, 100), monthRecords };
            };
            
            // Función para completar onboarding
            const completeOnboarding = () => {
                setShowOnboarding(false);
                setHasSeenOnboarding(true);
                safeLocalStorage.setItem('onboarding_completed', 'true');
                showToast('🎉 ¡Bienvenido a ControlCheck!', 'success');
            };

            // Funciones de formulario
            const addCommission = () => {
                setFormData({
                    ...formData,
                    commissions: [...formData.commissions, { name: '', amount: '' }]
                });
            };

            const addExpense = () => {
                setFormData({
                    ...formData,
                    expenses: [...formData.expenses, { name: '', amount: '' }]
                });
            };
            
            // Confirmar y agregar comisión pendiente al registro
            const confirmAddCommission = () => {
                if (!pendingCommission) return;
                const { name, amount } = pendingCommission;
                const dateToUse = targetRecordDate || new Date().toISOString().split('T')[0];
                const targetRecord = records.find(r => r.date === dateToUse);
                
                if (targetRecord) {
                    const newComm = { name, amount: amount.toString() };
                    const updatedCommissions = [...targetRecord.commissions, newComm];
                    const totalComm = updatedCommissions.reduce((sum, c) => sum + (parseFloat(c.amount) || 0), 0);
                    
                    const updatedRecord = {
                        ...targetRecord,
                        commissions: updatedCommissions,
                        totalComm: totalComm
                    };
                    
                    setRecords(records.map(r => r.id === targetRecord.id ? updatedRecord : r));
                    showToast(`✓ ${name.split('(')[0].trim()} agregada - $${amount}`, 'success');
                }
                setPendingCommission(null);
            };

            const submitRecord = async (e) => {
                e.preventDefault();
                
                // MEJORA #7: Indicador de carga
                setIsLoading(true);
                setLoadingMessage('Guardando registro...');
                
                try {
                    // Validar fecha
                    const dateValidation = validateDate(formData.date);
                    if (!dateValidation.valid) {
                        showToast(dateValidation.error, 'error');
                        setIsLoading(false);
                        return;
                    }
                    
                    // MEJORA #2: Validación avanzada de horarios
                    if (formData.startTime && formData.endTime) {
                        const hoursValidation = validateWorkHours(formData.startTime, formData.endTime);
                        if (!hoursValidation.valid) {
                            showToast(hoursValidation.error, 'error');
                            setIsLoading(false);
                            return;
                        }
                    }
                    
                    // MEJORA #2: Validar registro duplicado de fecha
                    const existingRecord = records.find(r => 
                        r.date === formData.date && r.id !== editingId
                    );
                    
                    if (existingRecord) {
                        showToast('Ya existe un registro para esta fecha. Edita el registro existente.', 'error');
                        setIsLoading(false);
                        return;
                    }
                    
                    // Validar comisiones y gastos
                    const invalidComm = formData.commissions.some(c => c.name && (!c.amount || parseFloat(c.amount) < 0));
                    const invalidExp = formData.expenses.some(e => e.name && (!e.amount || parseFloat(e.amount) < 0));
                    
                    if (invalidComm || invalidExp) {
                        showToast('Los montos deben ser números positivos', 'error');
                        setIsLoading(false);
                        return;
                    }
                    
                    const totalComm = formData.commissions.reduce((sum, c) => sum + (parseFloat(c.amount) || 0), 0);
                    const totalExp = formData.expenses.reduce((sum, e) => sum + (parseFloat(e.amount) || 0), 0);
                    const currentRates = getCurrentRates();
                    
                    // Auto-detectar día festivo
                    const isHoliday = HOLIDAYS_2026.find(h => h.date === formData.date);
                    const effectiveStatus = isHoliday && formData.status === 'worked' ? 'holiday' : formData.status;
                    const baseSalary = currentRates[effectiveStatus];
                    
                    if (isHoliday && formData.status === 'worked') {
                        showToast(`📅 Día festivo detectado: ${isHoliday.name} — tarifa festiva aplicada`, 'info');
                    }
                    
                    // Calcular horas trabajadas si están presentes (mejorado para cruzar medianoche)
                    let hoursWorked = null;
                    if (formData.startTime && formData.endTime) {
                        const start = new Date(`2000-01-01T${formData.startTime}`);
                        const end = new Date(`2000-01-01T${formData.endTime}`);
                        hoursWorked = (end - start) / (1000 * 60 * 60);
                        
                        // Si es negativo, cruza medianoche
                        if (hoursWorked < 0) {
                            hoursWorked += 24;
                        }
                    }
                    
                    // MEJORA #3: Guardar unitType explícitamente
                    const newRecord = {
                        id: editingId || Date.now(),
                        ...formData,
                        status: effectiveStatus,
                        unitType: selectedUnitType || 'crafter',
                        baseSalary,
                        totalComm,
                        totalExp,
                        hoursWorked
                    };
                    
                    // Simular delay para feedback visual
                    await new Promise(resolve => setTimeout(resolve, 300));
                    
                    if (editingId) {
                        setRecords(records.map(r => r.id === editingId ? newRecord : r));
                        showToast('✓ Registro actualizado correctamente', 'success');
                    } else {
                        setRecords([...records, newRecord]);
                        showToast('✓ Registro creado exitosamente', 'success');
                    }
                    
                    setFormData(initialFormData);
                    setSelectedUnitType(''); // Reset
                    setEditingId(null);
                    setViewMode('calendar');
                    setActiveTab(returnTab);
                } catch (error) {
                    console.error('Error al guardar:', error);
                    showToast('Error al guardar. Intenta nuevamente.', 'error');
                } finally {
                    setIsLoading(false);
                    setLoadingMessage('');
                }
            };

            const deleteRecord = (id) => {
                setModalState({
                    isOpen: true,
                    type: 'delete',
                    data: id,
                    title: '¿Eliminar registro?',
                    message: 'Esta acción no se puede deshacer.',
                    confirmText: 'Eliminar',
                    confirmColor: 'rose',
                    onConfirm: () => {
                        setRecords(records.filter(r => r.id !== id));
                        showToast('Registro eliminado', 'info');
                    }
                });
            };

            const handleResetData = () => {
                setModalState({
                    isOpen: true,
                    type: 'reset',
                    title: '⚠️ Restablecer Datos',
                    message: 'Esto eliminará TODOS los registros permanentemente. Esta acción no se puede deshacer.',
                    confirmText: 'Eliminar Todo',
                    confirmColor: 'rose',
                    onConfirm: () => {
                        setRecords([]);
                        safeLocalStorage.removeItem('worktracker_records');
                        setSelectedRecords([]);
                        setIsMultiSelectMode(false);
                        showToast('Todos los datos han sido eliminados', 'info');
                    }
                });
            };

            const handleBulkDelete = () => {
                setModalState({
                    isOpen: true,
                    type: 'bulkDelete',
                    title: `¿Eliminar ${selectedRecords.length} registros?`,
                    message: 'Esta acción no se puede deshacer.',
                    confirmText: 'Eliminar',
                    confirmColor: 'rose',
                    onConfirm: () => {
                        setRecords(records.filter(r => !selectedRecords.includes(r.id)));
                        setSelectedRecords([]);
                        setIsMultiSelectMode(false);
                        showToast(`${selectedRecords.length} registros eliminados`, 'info');
                    }
                });
            };

            const toggleRecordSelection = (id) => {
                setSelectedRecords(prev => 
                    prev.includes(id) ? prev.filter(i => i !== id) : [...prev, id]
                );
            };

            const filteredRecords = useMemo(() => {
                return records.filter(r => {
                    const recordDate = new Date(r.date + "T00:00:00");
                    
                    if (selectedPeriod !== 'custom') {
                        const period = [...payrollPeriods, ...commissionPeriods].find(p => p.label === selectedPeriod);
                        if (period) {
                            if (recordDate < period.startDate || recordDate > period.endDate) return false;
                        }
                    } else {
                        if (filterStartDate && recordDate < new Date(filterStartDate + "T00:00:00")) return false;
                        if (filterEndDate && recordDate > new Date(filterEndDate + "T00:00:00")) return false;
                    }
                    
                    // Filtro por estado (trabajado, descanso, etc.)
                    if (!filterStatuses.includes('all')) {
                        // Filtro especial para comisiones
                        if (filterStatuses.includes('with_commissions')) {
                            const hasCommissions = r.totalComm > 0;
                            if (!hasCommissions) return false;
                        }
                        // Filtro especial para gastos
                        if (filterStatuses.includes('with_expenses')) {
                            const hasExpenses = r.totalExp > 0;
                            if (!hasExpenses) return false;
                        }
                        // Filtros normales de estado (excluyendo los especiales)
                        const normalStatuses = filterStatuses.filter(s => s !== 'with_commissions' && s !== 'with_expenses');
                        if (normalStatuses.length > 0 && !normalStatuses.includes(r.status)) {
                            return false;
                        }
                    }
                    
                    if (searchQuery) {
                        const query = searchQuery.toLowerCase();
                        const matchesUnit = (r.unit || '').toLowerCase().includes(query);
                        const matchesDescription = (r.description || '').toLowerCase().includes(query);
                        const matchesDate = r.date.includes(query);
                        if (!matchesUnit && !matchesDescription && !matchesDate) return false;
                    }
                    
                    return true;
                });
            }, [records, filterStartDate, filterEndDate, filterStatuses, selectedPeriod, payrollPeriods, commissionPeriods, searchQuery]);

            const totals = useMemo(() => {
                const worked = filteredRecords.reduce((sum, r) => sum + r.baseSalary, 0);
                const commissions = filteredRecords.reduce((sum, r) => sum + r.totalComm, 0);
                const expenses = filteredRecords.reduce((sum, r) => sum + r.totalExp, 0);
                return {
                    worked,
                    commissions,
                    expenses,
                    total: worked + commissions - expenses
                };
            }, [filteredRecords]);

            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const firstDayOfMonth = new Date(currentYear, currentMonth, 1).getDay();
            
            const calendarDays = useMemo(() => {
                const days = [];
                for (let i = 0; i < firstDayOfMonth; i++) {
                    days.push(null);
                }
                for (let day = 1; day <= daysInMonth; day++) {
                    days.push(day);
                }
                return days;
            }, [currentMonth, currentYear, daysInMonth, firstDayOfMonth]);

            const getRecordForDate = (day) => {
                if (!day) return null;
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                return records.find(r => r.date === dateStr);
            };

            const handleDayClick = (day) => {
                if (!day) return;
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const existingRecord = getRecordForDate(day);
                
                if (existingRecord) {
                    // Si existe registro → abrir formulario en modo edición
                    setEditingId(existingRecord.id);
                    setFormData(existingRecord);
                } else {
                    // Si no existe → abrir formulario nuevo con fecha pre-llenada
                    setEditingId(null);
                    setFormData({...initialFormData, date: dateStr});
                }
                setReturnTab(activeTab);
                setActiveTab('calendar');
                setViewMode('form');
            };

            const navigateMonth = (direction) => {
                let newMonth = currentMonth + direction;
                let newYear = currentYear;
                
                if (newMonth > 11) {
                    newMonth = 0;
                    newYear++;
                } else if (newMonth < 0) {
                    newMonth = 11;
                    newYear--;
                }
                
                setCurrentMonth(newMonth);
                setCurrentYear(newYear);
            };

            const selectMonth = (monthIndex) => {
                setCurrentMonth(monthIndex);
                setShowMonthDropdown(false);
            };

            const handleStatusToggle = (status) => {
                if (status === 'all') {
                    setFilterStatuses(['all']);
                } else {
                    const newStatuses = filterStatuses.includes('all') 
                        ? [status]
                        : filterStatuses.includes(status)
                            ? filterStatuses.filter(s => s !== status)
                            : [...filterStatuses, status];
                    
                    if (newStatuses.length === 0) {
                        setFilterStatuses(['all']);
                    } else {
                        setFilterStatuses(newStatuses);
                    }
                }
            };

            return (
                <div className="min-h-screen bg-dark-bg pb-24">
                    {/* MEJORA #13: Indicador de modo offline */}
                    {!isOnline && (
                        <div className="fixed top-0 left-0 right-0 bg-amber-500 text-white text-center py-2 text-sm font-bold z-[60] shadow-lg">
                            <div className="flex items-center justify-center gap-2">
                                <svg className="w-4 h-4 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M18.364 5.636a9 9 0 010 12.728m0 0l-2.829-2.829m2.829 2.829L21 21M15.536 8.464a5 5 0 010 7.072m0 0l-2.829-2.829m-4.243 2.829a4.978 4.978 0 01-1.414-2.83m-1.414 5.658a9 9 0 01-2.167-9.238m7.824 2.167a1 1 0 111.414 1.414m-1.414-1.414L3 3m8.293 8.293l1.414 1.414" />
                                </svg>
                                📡 Sin conexión - Los cambios se guardan localmente
                            </div>
                        </div>
                    )}
                    
                    {/* MEJORA #7: Indicador de carga global */}
                    {isLoading && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-[60] flex items-center justify-center">
                            <div className="bg-dark-card p-6 rounded-xl shadow-xl border border-dark-border flex flex-col items-center gap-3">
                                <div className="w-12 h-12 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin"></div>
                                <p className="text-white font-bold">{loadingMessage || 'Cargando...'}</p>
                            </div>
                        </div>
                    )}
                    {/* Contenedor de Toasts */}
                    <div className="toast-container">
                        {toasts.map(toast => (
                            <Toast
                                key={toast.id}
                                message={toast.message}
                                type={toast.type}
                                onClose={() => removeToast(toast.id)}
                            />
                        ))}
                    </div>

                    {/* Modal */}
                    <Modal
                        isOpen={modalState.isOpen}
                        onClose={() => setModalState({ ...modalState, isOpen: false })}
                        onConfirm={modalState.onConfirm}
                        title={modalState.title}
                        message={modalState.message}
                        confirmText={modalState.confirmText}
                        confirmColor={modalState.confirmColor}
                    />

                    {/* Header simplificado */}
                    <div className="glass-effect sticky top-0 z-40 px-6 py-4 mb-1">
                        <div className="max-w-md mx-auto">
                            <div className="flex items-center gap-3 mb-2">
                                <div className="w-11 h-11 rounded-xl bg-gradient-to-br from-emerald-500 to-emerald-600 flex items-center justify-center shadow-lg">
                                    <Briefcase size={20} className="text-white" />
                                </div>
                                <div className="flex-1">
                                    <h1 className="text-lg font-black text-white tracking-tight">ControlCheck</h1>
                                    <p className="text-xs font-semibold text-emerald-400">{getGreeting()}</p>
                                </div>
                                <button 
                                    onClick={() => setShowUserProfile(true)}
                                    className="w-12 h-12 rounded-full bg-gradient-to-br from-emerald-500 to-emerald-600 flex items-center justify-center shadow-lg hover:scale-105 transition-transform active:scale-95"
                                >
                                    <User size={22} className="text-white" />
                                </button>
                            </div>
                        </div>
                    </div>

                    <main className="max-w-md mx-auto px-4 space-y-4">
                        
                        {/* MEJORA #8: Breadcrumb contextual */}
                        {(() => {
                            const path = [];
                            
                            if (activeTab === 'calendar' && viewMode === 'form') {
                                path.push({ label: 'Calendario', onClick: () => { setViewMode('calendar'); setActiveTab(returnTab); } });
                                path.push({ label: editingId ? 'Editar Registro' : 'Nuevo Registro', onClick: null });
                            } else if (activeTab === 'history') {
                                path.push({ label: 'Historial', onClick: null });
                                if (isMultiSelectMode) path.push({ label: `${selectedRecords.length} seleccionados`, onClick: null });
                            } else if (activeTab === 'dashboard') {
                                path.push({ label: 'Resumen', onClick: null });
                            }
                            
                            if (path.length > 0) {
                                return (
                                    <div className="flex items-center gap-2 text-xs text-gray-500 mb-2 font-semibold">
                                        {path.map((item, i) => (
                                            <React.Fragment key={i}>
                                                {i > 0 && (
                                                    <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                                                    </svg>
                                                )}
                                                {item.onClick ? (
                                                    <button 
                                                        onClick={item.onClick}
                                                        className="hover:text-emerald-400 transition-colors"
                                                    >
                                                        {item.label}
                                                    </button>
                                                ) : (
                                                    <span className={i === path.length - 1 ? 'text-white font-bold' : ''}>
                                                        {item.label}
                                                    </span>
                                                )}
                                            </React.Fragment>
                                        ))}
                                    </div>
                                );
                            }
                            return null;
                        })()}
                        
                        {activeTab === 'dashboard' && (
                            <div className="space-y-4 animate-fade-in">
                                
                                {/* Card Principal de Totales */}
                                <div className="relative overflow-hidden rounded-xl shadow-xl">
                                    <div className={`absolute inset-0 bg-gradient-to-br from-emerald-600 via-emerald-700 to-teal-800`}></div>
                                    <div className="absolute inset-0 bg-gradient-to-br from-white/[0.06] to-transparent"></div>
                                    <div className="absolute -top-10 -right-10 w-40 h-40 bg-white/[0.04] rounded-full"></div>
                                    <div className="absolute -bottom-8 -left-8 w-32 h-32 bg-white/[0.03] rounded-full"></div>
                                    
                                    <div className="relative p-6">
                                        {(() => {
                                            const now = new Date();
                                            const currentPeriod = commissionPeriods.find(p => now >= p.startDate && now <= p.endDate);
                                            const payDayNum = currentPeriod ? currentPeriod.payDay.getDate() : null;
                                            return (
                                                <div className="flex items-center justify-between mb-4">
                                                    <div className="flex items-center gap-2">
                                                        <div className="w-11 h-11 rounded-xl bg-white/20 flex items-center justify-center backdrop-blur">
                                                            <DollarSign size={18} className="text-white" />
                                                        </div>
                                                        <div>
                                                            <p className="text-emerald-100 text-xs font-bold uppercase tracking-wider">
                                                                {currentPeriod ? currentPeriod.label : 'Periodo actual'}
                                                            </p>
                                                            {payDayNum && (
                                                                <p className="text-emerald-200/70 text-xs font-semibold">
                                                                    Cobro: día {payDayNum}
                                                                </p>
                                                            )}
                                                        </div>
                                                    </div>
                                                    <div className="flex items-center gap-1.5">
                                                        <TrendingUp size={14} className="text-emerald-200" />
                                                        <span className="text-xs font-bold text-emerald-200">{filteredRecords.length} día{filteredRecords.length !== 1 ? 's' : ''}</span>
                                                    </div>
                                                </div>
                                            );
                                        })()}
                                        
                                        <div className="mb-6">
                                            <p className="text-white text-5xl font-black tracking-tight mb-0.5" style={{letterSpacing: '-0.03em'}}>
                                                ${totals.total.toLocaleString('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                                            </p>
                                            <p className="text-emerald-100/80 text-xs font-bold uppercase tracking-widest">Total a recibir</p>
                                        </div>
                                        
                                        <div className="grid grid-cols-3 gap-2">
                                            <div className="bg-white/10 backdrop-blur rounded-xl p-3 border border-white/20">
                                                <div className="flex items-center gap-1.5 mb-1">
                                                    <Clock size={12} className="text-emerald-200" />
                                                    <p className="text-xs text-emerald-100 font-bold uppercase tracking-wide">Trabajo</p>
                                                </div>
                                                <p className="text-white text-base font-black">${totals.worked.toLocaleString('es-MX', { minimumFractionDigits: 2 })}</p>
                                            </div>
                                            <div className="bg-white/10 backdrop-blur rounded-xl p-3 border border-white/20">
                                                <div className="flex items-center gap-1.5 mb-1">
                                                    <Sparkles size={12} className="text-emerald-200" />
                                                    <p className="text-xs text-emerald-100 font-bold uppercase tracking-wide">Comisión</p>
                                                </div>
                                                <p className="text-white text-base font-black">${totals.commissions.toLocaleString('es-MX', { minimumFractionDigits: 2 })}</p>
                                            </div>
                                            <div className="bg-white/10 backdrop-blur rounded-xl p-3 border border-white/20">
                                                <div className="flex items-center gap-1.5 mb-1">
                                                    <CreditCard size={12} className="text-emerald-200" />
                                                    <p className="text-xs text-emerald-100 font-bold uppercase tracking-wide">Gastos</p>
                                                </div>
                                                <p className="text-white text-base font-black">${totals.expenses.toLocaleString('es-MX', { minimumFractionDigits: 2 })}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* Estadísticas Rápidas */}
                                {filteredRecords.length > 0 && (() => {
                                    const workedDays = filteredRecords.filter(r => r.status === 'worked');
                                    const totalHours = workedDays.reduce((sum, r) => sum + (r.hoursWorked || 0), 0);
                                    const totalComms = filteredRecords.reduce((sum, r) => sum + (r.commissions?.length || 0), 0);
                                    const avgDaily = filteredRecords.length > 0 
                                        ? filteredRecords.reduce((sum, r) => sum + (r.baseSalary || 0) + (r.totalComm || 0) - (r.totalExp || 0), 0) / filteredRecords.length 
                                        : 0;
                                    const bestDay = filteredRecords.reduce((best, r) => {
                                        const dayTotal = (r.baseSalary || 0) + (r.totalComm || 0) - (r.totalExp || 0);
                                        return dayTotal > best.total ? { total: dayTotal, date: r.date, unit: r.unit } : best;
                                    }, { total: 0, date: '', unit: '' });
                                    
                                    return (
                                        <div className="grid grid-cols-2 gap-3">
                                            <div className="glass-effect rounded-xl p-4 shadow-xl border-l-[3px] border-l-blue-500">
                                                <div className="flex items-center justify-between mb-2">
                                                    <div className="w-11 h-11 rounded-xl bg-blue-500/15 flex items-center justify-center">
                                                        <TrendingUp size={18} className="text-blue-400" />
                                                    </div>
                                                    <p className="text-xs font-bold text-gray-500 uppercase">Promedio</p>
                                                </div>
                                                <p className="text-xl font-black text-white">${avgDaily.toLocaleString('es-MX', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</p>
                                                <p className="text-xs text-gray-400 font-semibold mt-0.5">por día trabajado</p>
                                            </div>
                                            <div className="glass-effect rounded-xl p-4 shadow-xl border-l-[3px] border-l-emerald-500">
                                                <div className="flex items-center justify-between mb-2">
                                                    <div className="w-11 h-11 rounded-xl bg-emerald-500/15 flex items-center justify-center">
                                                        <Clock size={18} className="text-emerald-400" />
                                                    </div>
                                                    <p className="text-xs font-bold text-gray-500 uppercase">Horas</p>
                                                </div>
                                                <p className="text-xl font-black text-white">{totalHours.toFixed(1)}<span className="text-sm text-gray-400 ml-0.5">h</span></p>
                                                <p className="text-xs text-gray-400 font-semibold mt-0.5">{workedDays.length} días trabajados</p>
                                            </div>
                                            <div className="glass-effect rounded-xl p-4 shadow-xl border-l-[3px] border-l-amber-500">
                                                <div className="flex items-center justify-between mb-2">
                                                    <div className="w-11 h-11 rounded-xl bg-amber-500/15 flex items-center justify-center">
                                                        <Sparkles size={18} className="text-amber-400" />
                                                    </div>
                                                    <p className="text-xs font-bold text-gray-500 uppercase">Comisiones</p>
                                                </div>
                                                <p className="text-xl font-black text-white">{totalComms}</p>
                                                <p className="text-xs text-gray-400 font-semibold mt-0.5">servicios realizados</p>
                                            </div>
                                            <div className="glass-effect rounded-xl p-4 shadow-xl border-l-[3px] border-l-purple-500">
                                                <div className="flex items-center justify-between mb-2">
                                                    <div className="w-11 h-11 rounded-xl bg-purple-500/15 flex items-center justify-center">
                                                        <svg className="w-4.5 h-4.5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                                                        </svg>
                                                    </div>
                                                    <p className="text-xs font-bold text-gray-500 uppercase">Mejor día</p>
                                                </div>
                                                <p className="text-xl font-black text-white">${bestDay.total.toLocaleString('es-MX', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</p>
                                                {bestDay.date && <p className="text-xs text-gray-400 font-semibold mt-0.5">{new Date(bestDay.date + 'T00:00:00').toLocaleDateString('es-MX', { day: 'numeric', month: 'short' })}</p>}
                                            </div>
                                        </div>
                                    );
                                })()}

                                {/* Actividad del Periodo - mini resumen por estado */}
                                {filteredRecords.length > 0 && (
                                    <div className="glass-effect rounded-xl p-4 shadow-xl">
                                        <h3 className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3 flex items-center gap-2">
                                            <BarChart3 size={14} className="text-emerald-400" />
                                            Actividad del Periodo
                                        </h3>
                                        <div className="space-y-2">
                                            {Object.entries(STATUS_LABELS).map(([status, label]) => {
                                                const count = filteredRecords.filter(r => r.status === status).length;
                                                const total = filteredRecords
                                                    .filter(r => r.status === status)
                                                    .reduce((sum, r) => sum + (r.baseSalary || 0) + (r.totalComm || 0) - (r.totalExp || 0), 0);
                                                const pct = filteredRecords.length > 0 ? (count / filteredRecords.length) * 100 : 0;
                                                
                                                if (count === 0) return null;
                                                
                                                return (
                                                    <div key={status} className="p-3 bg-dark-hover rounded-xl">
                                                        <div className="flex items-center justify-between mb-1.5">
                                                            <div className="flex items-center gap-2">
                                                                <div className={`w-2.5 h-2.5 rounded-full ${STATUS_COLORS[status]}`}></div>
                                                                <span className="text-xs font-bold text-white">{label}</span>
                                                                <span className="text-xs text-gray-500">{count}d</span>
                                                            </div>
                                                            <span className={`text-sm font-black ${STATUS_COLORS_TEXT[status]}`}>
                                                                ${total.toLocaleString('es-MX', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                                                            </span>
                                                        </div>
                                                        <div className="w-full h-1.5 bg-dark-border rounded-full overflow-hidden">
                                                            <div className={`h-full rounded-full ${STATUS_COLORS[status]} transition-all duration-500`} style={{width: `${pct}%`}}></div>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                )}

                                {/* Mini Calendario en Dashboard */}
                                <div className="glass-effect rounded-xl p-4 shadow-xl">
                                    <div className="flex items-center justify-between mb-3">
                                        <button 
                                            onClick={() => navigateMonth(-1)} 
                                            aria-label="Mes anterior"
                                            className="w-9 h-9 flex items-center justify-center rounded-lg bg-dark-hover hover:bg-dark-card transition-all"
                                        >
                                            <ChevronLeft size={18} className="text-gray-400" />
                                        </button>
                                        <h3 className="text-sm font-black text-white">
                                            {MONTH_NAMES_FULL[currentMonth]} {currentYear}
                                        </h3>
                                        <button 
                                            onClick={() => navigateMonth(1)} 
                                            aria-label="Mes siguiente"
                                            className="w-9 h-9 flex items-center justify-center rounded-lg bg-dark-hover hover:bg-dark-card transition-all"
                                        >
                                            <ChevronRight size={18} className="text-gray-400" />
                                        </button>
                                    </div>
                                    
                                    {/* Días headers */}
                                    <div className="calendar-grid mb-1">
                                        {DAY_NAMES.map(d => (
                                            <div key={d} className="text-center text-xs font-bold text-gray-600 uppercase">{d}</div>
                                        ))}
                                    </div>
                                    
                                    {/* Grid de días */}
                                    <div className="calendar-grid">
                                        {calendarDays.map((day, idx) => {
                                            if (!day) return <div key={idx} className="aspect-square"></div>;
                                            const record = getRecordForDate(day);
                                            const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                                            const holiday = HOLIDAYS_2026.find(h => h.date === dateStr);
                                            const isToday = new Date().getDate() === day && new Date().getMonth() === currentMonth && new Date().getFullYear() === currentYear;
                                            
                                            return (
                                                <button
                                                    key={idx}
                                                    onClick={() => handleDayClick(day)}
                                                    title={holiday ? holiday.name : ''}
                                                    className={`aspect-square rounded-lg flex flex-col items-center justify-center text-xs font-bold transition-all ${
                                                        record 
                                                            ? `${STATUS_COLORS[record.status]} text-white shadow-sm` 
                                                            : holiday
                                                                ? 'bg-purple-500/15 text-purple-300'
                                                                : 'bg-dark-card/60 text-gray-500 hover:bg-dark-hover hover:text-white'
                                                    } ${isToday ? 'ring-2 ring-emerald-400 ring-offset-1 ring-offset-dark-bg' : ''}`}
                                                >
                                                    <span className="text-xs font-black">{day}</span>
                                                    {record && (
                                                        <span className="text-[10px] opacity-80 font-bold">${(record.baseSalary + record.totalComm - record.totalExp).toFixed(0)}</span>
                                                    )}
                                                </button>
                                            );
                                        })}
                                    </div>
                                    
                                    {/* Leyenda compacta */}
                                    <div className="flex flex-wrap gap-x-3 gap-y-1 justify-center mt-3 pt-3 border-t border-dark-border/40">
                                        {Object.entries(STATUS_LABELS).map(([key, label]) => (
                                            <div key={key} className="flex items-center gap-1">
                                                <div className={`w-2 h-2 rounded-full ${STATUS_COLORS[key]}`}></div>
                                                <span className="text-xs text-gray-500 font-semibold">{label}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                            </div>
                        )}

                        {activeTab === 'calendar' && (
                            <div className="space-y-4 animate-fade-in">
                                {viewMode === 'calendar' ? (
                                    <>
                                        {/* Controles del Calendario */}
                                        <div className="glass-effect rounded-xl p-4 shadow-xl">
                                            <div className="flex items-center justify-between mb-4">
                                                <button 
                                                    onClick={() => navigateMonth(-1)} aria-label="Mes anterior"
                                                    className="w-11 h-11 flex items-center justify-center rounded-xl bg-dark-hover hover:bg-dark-card transition-all"
                                                >
                                                    <ChevronLeft size={20} className="text-gray-400" />
                                                </button>
                                                
                                                <div className="relative">
                                                    <button 
                                                        onClick={() => setShowMonthDropdown(!showMonthDropdown)}
                                                        className="flex items-center gap-2 px-4 py-2 rounded-xl bg-dark-hover hover:bg-dark-card transition-all"
                                                    >
                                                        <span className="text-sm font-black text-white">
                                                            {MONTH_NAMES_FULL[currentMonth]} {currentYear}
                                                        </span>
                                                        <ChevronDown size={16} className="text-gray-400" />
                                                    </button>
                                                    
                                                    {showMonthDropdown && (
                                                        <div className="absolute top-full mt-2 left-1/2 -translate-x-1/2 glass-effect rounded-xl p-2 shadow-2xl z-50 dropdown-menu w-48">
                                                            {MONTH_NAMES_FULL.map((month, idx) => (
                                                                <button
                                                                    key={idx}
                                                                    onClick={() => selectMonth(idx)}
                                                                    className={`w-full text-left px-3 py-2 rounded-lg text-xs font-bold transition-all ${
                                                                        idx === currentMonth 
                                                                            ? 'bg-emerald-500 text-white' 
                                                                            : 'text-gray-400 hover:bg-dark-hover'
                                                                    }`}
                                                                >
                                                                    {month}
                                                                </button>
                                                            ))}
                                                        </div>
                                                    )}
                                                </div>
                                                
                                                <button 
                                                    onClick={() => navigateMonth(1)} aria-label="Mes siguiente"
                                                    className="w-11 h-11 flex items-center justify-center rounded-xl bg-dark-hover hover:bg-dark-card transition-all"
                                                >
                                                    <ChevronRight size={20} className="text-gray-400" />
                                                </button>
                                            </div>

                                            {/* Días de la semana */}
                                            <div className="calendar-grid mb-2">
                                                {DAY_NAMES.map(day => (
                                                    <div key={day} className="text-center text-xs font-bold text-gray-500 uppercase tracking-wider">
                                                        {day}
                                                    </div>
                                                ))}
                                            </div>

                                            {/* Grid de días del mes */}
                                            <div className="calendar-grid">
                                                {calendarDays.map((day, idx) => {
                                                    if (!day) return <div key={idx} className="aspect-square"></div>;
                                                    
                                                    const record = getRecordForDate(day);
                                                    const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                                                    const holiday = HOLIDAYS_2026.find(h => h.date === dateStr);
                                                    const isToday = new Date().getDate() === day && new Date().getMonth() === currentMonth && new Date().getFullYear() === currentYear;
                                                    
                                                    return (
                                                        <button
                                                            key={idx}
                                                            onClick={() => handleDayClick(day)}
                                                            title={holiday ? holiday.name : ''}
                                                            className={`aspect-square rounded-xl p-1 flex flex-col items-center justify-center text-xs font-bold transition-all relative ${
                                                                record 
                                                                    ? `${STATUS_COLORS[record.status]} text-white shadow-md hover:scale-110 hover:shadow-lg` 
                                                                    : holiday
                                                                        ? 'bg-purple-500/15 text-purple-300 border border-purple-500/30 hover:bg-purple-500/25'
                                                                        : 'bg-dark-card/80 hover:bg-dark-hover text-gray-400 border border-dark-border/60 hover:border-emerald-500/40 hover:text-white'
                                                            } ${isToday ? 'ring-2 ring-emerald-400 ring-offset-2 ring-offset-dark-bg scale-105' : ''}`}
                                                        >
                                                            <span className={`text-sm font-black ${!record && !isToday ? 'text-gray-500' : ''}`}>{day}</span>
                                                            {record && (
                                                                <span className="text-xs opacity-90 font-bold mt-0.5 bg-black/20 px-1 rounded">
                                                                    ${(record.baseSalary + record.totalComm - record.totalExp).toFixed(0)}
                                                                </span>
                                                            )}
                                                            {holiday && !record && (
                                                                <span className="text-xs opacity-75 font-semibold mt-0.5 text-center leading-tight">
                                                                    {holiday.name.split(' ').slice(0, 2).join(' ')}
                                                                </span>
                                                            )}
                                                        </button>
                                                    );
                                                })}
                                            </div>
                                        </div>

                                        {/* Leyenda */}
                                        <div className="glass-effect p-3 rounded-xl">
                                            <div className="flex flex-wrap gap-x-4 gap-y-1.5 justify-center">
                                                {Object.entries(STATUS_LABELS).map(([key, label]) => (
                                                    <div key={key} className="flex items-center gap-1.5">
                                                        <div className={`w-2.5 h-2.5 rounded-full ${STATUS_COLORS[key]} shadow-sm`}></div>
                                                        <span className="text-xs font-semibold text-gray-500">{label}</span>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </>
                                ) : (
                                    // Formulario
                                    <form onSubmit={submitRecord} className="space-y-4 animate-slide-up">
                                        <div className="flex items-center justify-between">
                                            <div className="flex items-center gap-3">
                                                <div className={`w-11 h-11 rounded-xl ${editingId ? 'bg-blue-500/20' : 'bg-emerald-500/20'} flex items-center justify-center`}>
                                                    {editingId ? (
                                                        <svg className="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                                        </svg>
                                                    ) : (
                                                        <Plus size={20} className="text-emerald-400" />
                                                    )}
                                                </div>
                                                <h2 className="text-xl font-black text-white">{editingId ? 'Editar' : 'Nuevo'} Registro</h2>
                                            </div>
                                            <button 
                                                type="button"
                                                onClick={() => {
                                                    setViewMode('calendar');
                                                    setActiveTab(returnTab);
                                                    setEditingId(null);
                                                    setFormData(initialFormData);
                                                }}
                                                className="w-11 h-11 flex items-center justify-center glass-effect rounded-xl hover:bg-dark-hover transition-all border border-transparent hover:border-rose-500/30 group"
                                            >
                                                <X size={20} className="text-gray-400 group-hover:text-rose-400" />
                                            </button>
                                        </div>

                                        <div className="glass-effect p-5 rounded-xl shadow-xl space-y-5">
                                            {/* SECCIÓN: Fecha y Estado */}
                                            <div className="space-y-3">
                                                <p className="text-xs font-bold text-emerald-400 uppercase tracking-widest flex items-center gap-2">
                                                    <Calendar size={11} />
                                                    Información del día
                                                </p>
                                                <div>
                                                    <label className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 block">Fecha *</label>
                                                    <input 
                                                        type="date" 
                                                        value={formData.date} 
                                                        onChange={e => setFormData({...formData, date: e.target.value})} 
                                                        className="w-full bg-dark-hover border border-dark-border p-3 rounded-xl text-sm font-semibold outline-none text-white hover:border-emerald-500/50"
                                                        required
                                                    />
                                                </div>

                                                <div>
                                                    <label className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 block">Estado *</label>
                                                    <select 
                                                        value={formData.status} 
                                                        onChange={e => setFormData({...formData, status: e.target.value})} 
                                                        className="w-full bg-dark-hover border border-dark-border p-3 rounded-xl text-sm font-semibold outline-none text-white hover:border-emerald-500/50"
                                                    >
                                                        {Object.entries(STATUS_LABELS).map(([k,v]) => {
                                                            const currentRates = getCurrentRates();
                                                            return (
                                                                <option key={k} value={k}>{v} - ${currentRates[k].toFixed(2)}</option>
                                                            );
                                                        })}
                                                    </select>
                                                </div>
                                            </div>

                                            {/* All other sections hidden when descanso */}
                                            {formData.status !== 'rest' && (<>

                                            {/* Divider */}
                                            <div className="border-t border-dark-border/50"></div>

                                            {/* SECCIÓN: Horario */}
                                            <div className="space-y-3">
                                                <p className="text-xs font-bold text-blue-400 uppercase tracking-widest flex items-center gap-2">
                                                    <Clock size={11} />
                                                    Horario
                                                </p>
                                            <div className="grid grid-cols-2 gap-3">
                                                <div>
                                                    <label className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 block">Hora Inicio</label>
                                                    <input 
                                                        type="time" 
                                                        value={formData.startTime} 
                                                        onChange={e => {
                                                            const newStartTime = e.target.value;
                                                            // Calcular hora final automáticamente (8 horas después)
                                                            let newEndTime = '';
                                                            if (newStartTime) {
                                                                const [hours, minutes] = newStartTime.split(':').map(Number);
                                                                const startDate = new Date(2000, 0, 1, hours, minutes);
                                                                const endDate = new Date(startDate.getTime() + 8 * 60 * 60 * 1000); // +8 horas
                                                                newEndTime = `${String(endDate.getHours()).padStart(2, '0')}:${String(endDate.getMinutes()).padStart(2, '0')}`;
                                                            }
                                                            setFormData({...formData, startTime: newStartTime, endTime: newEndTime});
                                                        }} 
                                                        className="w-full bg-dark-hover border border-dark-border p-3 rounded-xl text-sm font-semibold outline-none text-white hover:border-emerald-500/50"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 block">Hora Fin</label>
                                                    <input 
                                                        type="time" 
                                                        value={formData.endTime} 
                                                        onChange={e => setFormData({...formData, endTime: e.target.value})} 
                                                        className="w-full bg-dark-hover border border-dark-border p-3 rounded-xl text-sm font-semibold outline-none text-white hover:border-emerald-500/50"
                                                    />
                                                </div>
                                            </div>
                                            
                                            {formData.startTime && formData.endTime && (
                                                (() => {
                                                    let hours = (new Date(`2000-01-01T${formData.endTime}`) - new Date(`2000-01-01T${formData.startTime}`)) / (1000 * 60 * 60);
                                                    if (hours <= 0) hours += 24;
                                                    return (
                                                        <div className="p-3 bg-emerald-500/20 border border-emerald-500/30 rounded-xl">
                                                            <p className="text-xs text-emerald-400 font-semibold">
                                                                ⏱️ Horas trabajadas: {hours.toFixed(2)}h {hours > 12 ? '(turno nocturno)' : ''}
                                                            </p>
                                                        </div>
                                                    );
                                                })()
                                            )}

                                            </div>

                                            {/* Divider */}
                                            <div className="border-t border-dark-border/50"></div>

                                            {/* SECCIÓN: Vehículo */}
                                            <div className="space-y-3">
                                                <p className="text-xs font-bold text-amber-400 uppercase tracking-widest flex items-center gap-2">
                                                    <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" /></svg>
                                                    Vehículo
                                                </p>
                                            <div>
                                                <label className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 block">Unidad</label>
                                                <input 
                                                    type="text" 
                                                    placeholder="Ej: OFICINA, UNIDAD 1" 
                                                    value={formData.unit} 
                                                    onChange={e => setFormData({...formData, unit: e.target.value})} 
                                                    maxLength={50}
                                                    className="w-full bg-dark-hover border border-dark-border p-3 rounded-xl text-sm font-semibold outline-none text-white placeholder-gray-500 hover:border-emerald-500/50"
                                                />
                                            </div>

                                            <div>
                                                <label className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 block">Tipo de Unidad</label>
                                                <select 
                                                    value={selectedUnitType}
                                                    onChange={e => setSelectedUnitType(e.target.value)}
                                                    className="w-full bg-dark-hover border border-dark-border p-3 rounded-xl text-sm font-semibold outline-none text-white hover:border-emerald-500/50"
                                                >
                                                    <option value="all">📋 Todas las unidades</option>
                                                    <option value="crafter">🚐 Crafter / Sprinter / Transporter / Urvan</option>
                                                    <option value="navigator">🚙 Limosina / Suburban / Navigator</option>
                                                    <option value="autobus">🚌 Autobús</option>
                                                </select>
                                                <p className="text-xs text-gray-500 mt-1.5 font-semibold">Filtra las comisiones preconfiguradas por tipo de vehículo</p>
                                            </div>
                                            </div>

                                            {/* Divider */}
                                            <div className="border-t border-dark-border/50"></div>

                                            {/* SECCIÓN: Notas */}
                                            <div>
                                                <label className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 block">Notas adicionales</label>
                                                <textarea 
                                                    placeholder="Notas adicionales..." 
                                                    value={formData.description} 
                                                    onChange={e => setFormData({...formData, description: e.target.value})} 
                                                    maxLength={500}
                                                    className="w-full bg-dark-hover border border-dark-border p-3 rounded-xl text-sm font-semibold outline-none text-white placeholder-gray-500 resize-none hover:border-emerald-500/50"
                                                    rows="2"
                                                />
                                            </div>

                                            {/* Divider */}
                                            <div className="border-t border-dark-border/50"></div>

                                            {/* SECCIÓN: Comisiones */}
                                            <div>
                                                <div className="flex justify-between items-center mb-3">
                                                    <label className="text-xs font-bold text-purple-400 uppercase tracking-widest flex items-center gap-2">
                                                        <Sparkles size={12} />
                                                        Comisiones
                                                    </label>
                                                    <div className="flex gap-2">
                                                        <button 
                                                            type="button" 
                                                            onClick={() => { setPreconfFilter('Desde Aeropuerto Cancún'); setShowCommissionsModal(true); }} 
                                                            className="text-xs font-bold text-blue-400 hover:text-blue-300 flex items-center gap-1 transition-colors"
                                                        >
                                                            <Sparkles size={14} /> Preconfiguradas
                                                        </button>
                                                        <button 
                                                            type="button" 
                                                            onClick={addCommission} 
                                                            className="text-xs font-bold text-emerald-400 hover:text-emerald-300 flex items-center gap-1 transition-colors"
                                                        >
                                                            <Plus size={14} /> Agregar
                                                        </button>
                                                    </div>
                                                </div>
                                                <div className="space-y-2">
                                                    {formData.commissions.map((comm, i) => (
                                                        <div key={i} className="space-y-2">
                                                            <div className="flex gap-2 items-center">
                                                                <input 
                                                                    placeholder="Nombre de comisión" 
                                                                    type="text" 
                                                                    maxLength={50}
                                                                    className="flex-1 bg-dark-hover border border-dark-border p-3 rounded-xl text-xs font-semibold outline-none text-white placeholder-gray-500 hover:border-emerald-500/50" 
                                                                    value={comm.name} 
                                                                    onChange={e => { 
                                                                        const newC = [...formData.commissions]; 
                                                                        newC[i].name = e.target.value; 
                                                                        setFormData({...formData, commissions: newC}); 
                                                                    }} 
                                                                />
                                                                <input 
                                                                    placeholder="$" 
                                                                    type="number" 
                                                                    step="0.01"
                                                                    min="0"
                                                                    className="w-28 bg-dark-hover border border-dark-border p-3 rounded-xl text-xs font-bold text-emerald-400 outline-none hover:border-emerald-500/50" 
                                                                    value={comm.amount} 
                                                                    onChange={e => { 
                                                                        const newC = [...formData.commissions]; 
                                                                        newC[i].amount = e.target.value; 
                                                                        setFormData({...formData, commissions: newC}); 
                                                                    }} 
                                                                />
                                                                <button 
                                                                    type="button" 
                                                                    onClick={() => { 
                                                                        const newC = formData.commissions.filter((_, idx) => idx !== i); 
                                                                        setFormData({...formData, commissions: newC}); 
                                                                    }}
                                                                    className="w-11 h-11 flex items-center justify-center rounded-xl hover:bg-rose-500/20 transition-colors group"
                                                                >
                                                                    <X size={16} className="text-gray-500 group-hover:text-rose-400" />
                                                                </button>
                                                            </div>

                                                        </div>
                                                    ))}
                                                </div>
                                            </div>

                                            {/* Divider */}
                                            <div className="border-t border-dark-border/50"></div>

                                            {/* SECCIÓN: Gastos */}
                                            <div>
                                                <div className="flex justify-between items-center mb-3">
                                                    <label className="text-xs font-bold text-rose-400 uppercase tracking-widest flex items-center gap-2">
                                                        <CreditCard size={12} />
                                                        Gastos
                                                    </label>
                                                    <button type="button" onClick={addExpense} className="text-xs font-bold text-rose-400 hover:text-rose-300 flex items-center gap-1 transition-colors">
                                                        <Plus size={14} /> Agregar
                                                    </button>
                                                </div>
                                                <div className="space-y-2">
                                                    {formData.expenses.map((exp, i) => (
                                                        <div key={i} className="flex gap-2 items-center">
                                                            <select 
                                                                className="flex-1 bg-dark-hover border border-dark-border p-3 rounded-xl text-xs font-semibold outline-none text-white hover:border-rose-500/50" 
                                                                value={exp.name} 
                                                                onChange={e => { 
                                                                    const newE = [...formData.expenses]; 
                                                                    newE[i].name = e.target.value; 
                                                                    setFormData({...formData, expenses: newE}); 
                                                                }}
                                                            >
                                                                <option value="">Seleccionar...</option>
                                                                <option value="Transporte">🚗 Transporte</option>
                                                                <option value="Comida">🍽️ Comida</option>
                                                                <option value="Herramientas">🔧 Herramientas</option>
                                                                <option value="Uniforme">👕 Uniforme</option>
                                                                <option value="Otro">📦 Otro</option>
                                                            </select>
                                                            <input 
                                                                placeholder="$" 
                                                                type="number" 
                                                                step="0.01"
                                                                min="0"
                                                                className="w-28 bg-dark-hover border border-dark-border p-3 rounded-xl text-xs font-bold text-rose-400 outline-none hover:border-rose-500/50" 
                                                                value={exp.amount} 
                                                                onChange={e => { 
                                                                    const newE = [...formData.expenses]; 
                                                                    newE[i].amount = e.target.value; 
                                                                    setFormData({...formData, expenses: newE}); 
                                                                }} 
                                                            />
                                                            <button 
                                                                type="button" 
                                                                onClick={() => { 
                                                                    const newE = formData.expenses.filter((_, idx) => idx !== i); 
                                                                    setFormData({...formData, expenses: newE}); 
                                                                }}
                                                                className="w-11 h-11 flex items-center justify-center rounded-xl hover:bg-rose-500/20 transition-colors group"
                                                            >
                                                                <X size={16} className="text-gray-500 group-hover:text-rose-400" />
                                                            </button>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                            </>)}

                                            {/* Rest status message */}
                                            {formData.status === 'rest' && (
                                                <div className="p-4 bg-blue-500/10 border border-blue-500/20 rounded-xl text-center">
                                                    <p className="text-xs font-semibold text-blue-400">💤 Día de descanso — no se requiere información adicional</p>
                                                </div>
                                            )}
                                        </div>

                                        <div className="flex gap-3">
                                            {editingId && (
                                                <button 
                                                    type="button"
                                                    onClick={() => deleteRecord(editingId)}
                                                    className="px-6 py-4 bg-rose-500/20 rounded-xl text-sm font-bold text-rose-400 border border-rose-500/30 hover:bg-rose-500/30 transition-all flex items-center justify-center gap-2"
                                                >
                                                    <Trash2 size={18} /> Eliminar
                                                </button>
                                            )}
                                            <button 
                                                type="submit"
                                                className="flex-1 px-6 py-4 bg-gradient-to-r from-emerald-500 to-emerald-600 rounded-xl text-sm font-black text-white shadow-lg shadow-emerald-500/20 hover:from-emerald-600 hover:to-emerald-700 transition-all active:scale-95 flex items-center justify-center gap-2"
                                            >
                                                {editingId ? <><Check size={20} /> Actualizar</> : <><Plus size={20} /> Crear</>}
                                            </button>
                                        </div>
                                    </form>
                                )}
                            </div>
                        )}

                        {activeTab === 'history' && (
                            <div className="space-y-3 animate-fade-in">
                                
                                {/* Header con acciones */}
                                <div className="flex items-center justify-between">
                                    <h2 className="text-xl font-black text-white px-1">Historial</h2>
                                    <div className="flex items-center gap-2">
                                        {records.length > 0 && (
                                            <button
                                                onClick={() => setIsMultiSelectMode(!isMultiSelectMode)}
                                                className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all ${
                                                    isMultiSelectMode
                                                        ? 'bg-emerald-500 text-white'
                                                        : 'bg-dark-hover text-gray-400 hover:bg-dark-card'
                                                }`}
                                            >
                                                {isMultiSelectMode ? 'Cancelar' : 'Seleccionar'}
                                            </button>
                                        )}
                                    </div>
                                </div>
                                
                                {isMultiSelectMode && selectedRecords.length > 0 && (
                                    <div className="glass-effect p-4 rounded-xl flex items-center justify-between animate-slide-down">
                                        <span className="text-sm font-bold text-white">{selectedRecords.length} seleccionado{selectedRecords.length !== 1 ? 's' : ''}</span>
                                        <button
                                            onClick={handleBulkDelete}
                                            className="px-4 py-2 bg-rose-500 rounded-xl text-xs font-bold text-white hover:bg-rose-600 transition-all flex items-center gap-2"
                                        >
                                            <Trash2 size={16} /> Eliminar
                                        </button>
                                    </div>
                                )}

                                {/* Mini Resumen del periodo filtrado */}
                                {filteredRecords.length > 0 && (
                                    <div className="glass-effect rounded-xl p-4 shadow-xl">
                                        <div className="grid grid-cols-3 gap-3">
                                            <div className="text-center">
                                                <p className="text-xs font-bold text-gray-500 uppercase mb-1">Días</p>
                                                <p className="text-lg font-black text-white">{filteredRecords.length}</p>
                                            </div>
                                            <div className="text-center">
                                                <p className="text-xs font-bold text-gray-500 uppercase mb-1">Comisiones</p>
                                                <p className="text-lg font-black text-amber-400">
                                                    ${filteredRecords.reduce((sum, r) => sum + (r.totalComm || 0), 0).toLocaleString('es-MX', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                                                </p>
                                            </div>
                                            <div className="text-center">
                                                <p className="text-xs font-bold text-gray-500 uppercase mb-1">Total</p>
                                                <p className="text-lg font-black text-emerald-400">
                                                    ${filteredRecords.reduce((sum, r) => sum + (r.baseSalary || 0) + (r.totalComm || 0) - (r.totalExp || 0), 0).toLocaleString('es-MX', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* Buscador + Botón Filtros */}
                                <div className="glass-effect rounded-xl p-4 shadow-xl space-y-3">
                                    <div className="flex gap-2">
                                        <div className="flex-1 relative">
                                            <Search size={16} className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500" />
                                            <input
                                                type="text"
                                                placeholder="Buscar..."
                                                value={searchQuery}
                                                onChange={e => setSearchQuery(e.target.value)}
                                                className="w-full bg-dark-hover border border-dark-border pl-10 pr-3 py-2.5 rounded-xl text-sm font-semibold outline-none text-white placeholder-gray-500 hover:border-emerald-500/50"
                                            />
                                        </div>
                                        <button
                                            onClick={() => setShowHistoryFilters(!showHistoryFilters)}
                                            className={`px-4 py-2.5 rounded-xl text-xs font-bold transition-all flex items-center gap-1.5 ${
                                                showHistoryFilters || !filterStatuses.includes('all') || selectedPeriod !== 'custom'
                                                    ? 'bg-emerald-500/20 border border-emerald-500/40 text-emerald-400'
                                                    : 'bg-dark-hover border border-dark-border text-gray-400 hover:bg-dark-card'
                                            }`}
                                        >
                                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                                            </svg>
                                            Filtros
                                            {(!filterStatuses.includes('all') || selectedPeriod !== 'custom') && (
                                                <span className="w-2 h-2 rounded-full bg-emerald-400"></span>
                                            )}
                                        </button>
                                    </div>

                                    {/* Filtros colapsables */}
                                    {showHistoryFilters && (
                                        <div className="space-y-3 pt-3 border-t border-dark-border/50 animate-slide-down">
                                            {/* Periodo */}
                                            <div>
                                                <label className="text-xs font-bold text-gray-500 uppercase tracking-wider mb-1.5 block">Periodo</label>
                                                
                                                {/* Tabs Nómina / Comisiones */}
                                                <div className="flex mb-2 bg-dark-hover rounded-xl overflow-hidden border border-dark-border">
                                                    <button 
                                                        onClick={() => setPeriodTabType('payroll')}
                                                        className={`flex-1 py-2 text-xs font-bold transition-all ${
                                                            periodTabType === 'payroll' 
                                                                ? 'bg-emerald-500/20 text-emerald-400' 
                                                                : 'text-gray-500 hover:text-gray-300'
                                                        }`}
                                                    >
                                                        💰 Nómina
                                                    </button>
                                                    <button 
                                                        onClick={() => setPeriodTabType('commission')}
                                                        className={`flex-1 py-2 text-xs font-bold transition-all ${
                                                            periodTabType === 'commission' 
                                                                ? 'bg-amber-500/20 text-amber-400' 
                                                                : 'text-gray-500 hover:text-gray-300'
                                                        }`}
                                                    >
                                                        ⭐ Comisiones
                                                    </button>
                                                </div>
                                                
                                                {/* Period list */}
                                                <div className="max-h-40 overflow-y-auto space-y-1 bg-dark-hover rounded-xl p-1.5 border border-dark-border">
                                                    <button 
                                                        onClick={() => { setSelectedPeriod('custom'); }}
                                                        className={`w-full text-left px-3 py-2 rounded-lg text-xs font-bold transition-all flex items-center gap-2 ${
                                                            selectedPeriod === 'custom' 
                                                                ? 'bg-emerald-500/20 text-emerald-400' 
                                                                : 'text-gray-400 hover:bg-dark-card'
                                                        }`}
                                                    >
                                                        📅 Personalizado
                                                        {selectedPeriod === 'custom' && <Check size={12} className="ml-auto text-emerald-400" />}
                                                    </button>
                                                    
                                                    {(periodTabType === 'payroll' ? payrollPeriods : commissionPeriods).map((period, idx) => {
                                                        const now = new Date();
                                                        const isCurrent = now >= period.startDate && now <= period.endDate;
                                                        const isSelected = selectedPeriod === period.label;
                                                        
                                                        return (
                                                            <button 
                                                                key={idx}
                                                                onClick={() => {
                                                                    setSelectedPeriod(period.label);
                                                                    setFilterStartDate('');
                                                                    setFilterEndDate('');
                                                                }}
                                                                className={`w-full text-left px-3 py-2 rounded-lg text-xs font-bold transition-all flex items-center gap-2 ${
                                                                    isSelected 
                                                                        ? 'bg-emerald-500/20 text-emerald-400' 
                                                                        : isCurrent
                                                                            ? 'bg-dark-card text-white ring-1 ring-emerald-500/30'
                                                                            : 'text-gray-400 hover:bg-dark-card'
                                                                }`}
                                                            >
                                                                <span>{periodTabType === 'payroll' ? '💰' : '⭐'}</span>
                                                                <span className="flex-1">{period.label}{period.payDay ? ` • Cobro: día ${typeof period.payDay === 'object' ? period.payDay.getDate() : period.payDay}` : ''}</span>
                                                                {isCurrent && <span className="px-1.5 py-0.5 bg-emerald-500/20 rounded text-[10px] font-black text-emerald-400 uppercase">Actual</span>}
                                                                {isSelected && <Check size={12} className="flex-shrink-0 text-emerald-400" />}
                                                            </button>
                                                        );
                                                    })}
                                                </div>
                                            </div>

                                            {selectedPeriod === 'custom' && (
                                                <div className="flex gap-3">
                                                    <div className="flex-1">
                                                        <label className="text-xs font-bold text-gray-500 uppercase mb-1 block">Inicio</label>
                                                        <input type="date" value={filterStartDate} onChange={e => setFilterStartDate(e.target.value)} 
                                                            className="w-full bg-dark-hover border border-dark-border p-2 rounded-lg text-xs font-semibold outline-none text-white hover:border-emerald-500/50" />
                                                    </div>
                                                    <div className="flex-1">
                                                        <label className="text-xs font-bold text-gray-500 uppercase mb-1 block">Fin</label>
                                                        <input type="date" value={filterEndDate} onChange={e => setFilterEndDate(e.target.value)} 
                                                            className="w-full bg-dark-hover border border-dark-border p-2 rounded-lg text-xs font-semibold outline-none text-white hover:border-emerald-500/50" />
                                                    </div>
                                                </div>
                                            )}

                                            {/* Estado */}
                                            <div>
                                                <label className="text-xs font-bold text-gray-500 uppercase tracking-wider mb-1.5 block">Estado</label>
                                                <div className="flex flex-wrap gap-1.5">
                                                    <button type="button" onClick={() => handleStatusToggle('all')}
                                                        className={`px-3 py-1.5 rounded-lg text-[11px] font-bold transition-all ${filterStatuses.includes('all') ? 'bg-emerald-500 text-white' : 'bg-dark-hover border border-dark-border text-gray-400'}`}>
                                                        Todo
                                                    </button>
                                                    {Object.entries(STATUS_LABELS).map(([key, label]) => (
                                                        <button key={key} type="button" onClick={() => handleStatusToggle(key)}
                                                            className={`px-3 py-1.5 rounded-lg text-[11px] font-bold transition-all ${filterStatuses.includes(key) ? `${STATUS_COLORS[key]} text-white` : 'bg-dark-hover border border-dark-border text-gray-400'}`}>
                                                            {label}
                                                        </button>
                                                    ))}
                                                    <button type="button" onClick={() => handleStatusToggle('with_commissions')}
                                                        className={`px-3 py-1.5 rounded-lg text-[11px] font-bold transition-all ${filterStatuses.includes('with_commissions') ? 'bg-yellow-500 text-white' : 'bg-dark-hover border border-dark-border text-gray-400'}`}>
                                                        💰 Comisiones
                                                    </button>
                                                    <button type="button" onClick={() => handleStatusToggle('with_expenses')}
                                                        className={`px-3 py-1.5 rounded-lg text-[11px] font-bold transition-all ${filterStatuses.includes('with_expenses') ? 'bg-red-500 text-white' : 'bg-dark-hover border border-dark-border text-gray-400'}`}>
                                                        📤 Gastos
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>

                                {/* Lista de registros - tarjetas mejoradas */}
                                <div className="space-y-2">
                                    {filteredRecords.length === 0 ? (
                                        <div className="glass-effect p-10 rounded-xl text-center">
                                            <div className="w-16 h-16 rounded-xl bg-gray-800/50 flex items-center justify-center mx-auto mb-4">
                                                <HistoryIcon size={28} className="text-gray-600" />
                                            </div>
                                            <p className="text-gray-400 text-sm font-bold mb-1">Sin registros</p>
                                            <p className="text-gray-600 text-xs">Ajusta los filtros o usa el botón <span className="text-emerald-400 font-bold">+</span> para agregar</p>
                                        </div>
                                    ) : (
                                        filteredRecords.map(r => {
                                            const unitShort = r.unit ? (r.unit.includes(' - ') ? r.unit.split(' - ')[0] : r.unit) : 'SIN UNIDAD';
                                            const totalDay = (r.baseSalary || 0) + (r.totalComm || 0) - (r.totalExp || 0);
                                            const commCount = r.commissions ? r.commissions.length : 0;
                                            
                                            return (
                                                <div key={r.id} 
                                                    onClick={() => {
                                                        if (!isMultiSelectMode) {
                                                            setSelectedDayRecord(r);
                                                            setShowDayDetailModal(true);
                                                        }
                                                    }}
                                                    className="glass-effect rounded-xl shadow-lg hover:bg-dark-hover transition-all cursor-pointer active:scale-[0.98]"
                                                >
                                                    <div className="flex items-center gap-3 p-3.5">
                                                        {isMultiSelectMode && (
                                                            <button
                                                                onClick={(e) => { e.stopPropagation(); toggleRecordSelection(r.id); }}
                                                                className="flex-shrink-0"
                                                            >
                                                                {selectedRecords.includes(r.id) ? (
                                                                    <CheckSquare size={22} className="text-emerald-400" />
                                                                ) : (
                                                                    <Square size={22} className="text-gray-600" />
                                                                )}
                                                            </button>
                                                        )}
                                                        
                                                        {/* Fecha badge */}
                                                        <div className={`flex-shrink-0 w-12 h-12 rounded-xl flex flex-col items-center justify-center ${STATUS_COLORS[r.status]} shadow-md`}>
                                                            <span className="text-base font-black text-white leading-none">{new Date(r.date + "T00:00:00").getDate()}</span>
                                                            <span className="uppercase text-xs font-bold text-white/80">{new Date(r.date + "T00:00:00").toLocaleDateString('es-MX', { month: 'short' })}</span>
                                                        </div>
                                                        
                                                        {/* Info */}
                                                        <div className="flex-1 min-w-0">
                                                            <div className="flex items-start justify-between gap-2">
                                                                <div className="min-w-0 flex-1">
                                                                    <h4 className="text-sm font-black text-white">{unitShort}</h4>
                                                                    <div className="flex items-center gap-2 mt-0.5 flex-wrap">
                                                                        <span className="text-xs font-bold text-gray-400 uppercase">
                                                                            {STATUS_LABELS[r.status]}
                                                                        </span>
                                                                        {r.startTime && r.endTime && (
                                                                            <span className="text-xs text-gray-500 font-semibold">
                                                                                • {r.startTime}–{r.endTime}
                                                                            </span>
                                                                        )}
                                                                    </div>
                                                                </div>
                                                                <div className="text-right flex-shrink-0">
                                                                    <p className="text-base font-black text-emerald-400">
                                                                        ${totalDay.toLocaleString('es-MX', { minimumFractionDigits: 2 })}
                                                                    </p>
                                                                </div>
                                                            </div>
                                                            
                                                            {/* Tags de comisiones y gastos */}
                                                            {(commCount > 0 || (r.totalExp || 0) > 0) && (
                                                                <div className="flex items-center gap-2 mt-1.5 flex-wrap">
                                                                    {commCount > 0 && (
                                                                        <span className="text-xs font-bold text-amber-400 bg-amber-500/15 px-2 py-0.5 rounded-full">
                                                                            {commCount} comisión{commCount !== 1 ? 'es' : ''} • ${(r.totalComm || 0).toFixed(0)}
                                                                        </span>
                                                                    )}
                                                                    {(r.totalExp || 0) > 0 && (
                                                                        <span className="text-xs font-bold text-rose-400 bg-rose-500/15 px-2 py-0.5 rounded-full">
                                                                            -${(r.totalExp || 0).toFixed(0)} gastos
                                                                        </span>
                                                                    )}
                                                                </div>
                                                            )}
                                                        </div>
                                                        
                                                        {/* Chevron */}
                                                        {!isMultiSelectMode && (
                                                            <ChevronRight size={18} className="text-gray-600 flex-shrink-0" />
                                                        )}
                                                    </div>
                                                </div>
                                            );
                                        })
                                    )}
                                </div>
                            </div>
                        )}

                    </main>

                    {/* Modal de Detalle del Día */}
                    {showDayDetailModal && selectedDayRecord && (() => {
                        const unitShort = selectedDayRecord.unit ? (selectedDayRecord.unit.includes(' - ') ? selectedDayRecord.unit.split(' - ')[0] : selectedDayRecord.unit) : 'Sin unidad';
                        const unitType = selectedDayRecord.unit && selectedDayRecord.unit.includes(' - ') ? selectedDayRecord.unit.split(' - ')[1] : '';
                        const totalDay = (selectedDayRecord.baseSalary || 0) + (selectedDayRecord.totalComm || 0) - (selectedDayRecord.totalExp || 0);
                        
                        return (
                        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm z-[55] flex items-start justify-center p-4 pt-8 pb-24 overflow-y-auto animate-fade-in"
                             onClick={() => setShowDayDetailModal(false)}>
                            <div className="glass-effect rounded-2xl max-w-md w-full my-auto animate-slide-up overflow-hidden"
                                 onClick={(e) => e.stopPropagation()}>
                                
                                {/* Header con gradiente */}
                                <div className={`p-5 ${STATUS_COLORS[selectedDayRecord.status]} relative overflow-hidden`}>
                                    <div className="absolute inset-0 bg-gradient-to-br from-white/[0.08] to-transparent"></div>
                                    <div className="absolute top-0 right-0 w-32 h-32 bg-white/[0.04] rounded-full -translate-y-1/2 translate-x-1/2"></div>
                                    <div className="relative flex items-center justify-between">
                                        <div className="flex items-center gap-3">
                                            <div className="w-14 h-14 rounded-2xl bg-white/20 backdrop-blur flex flex-col items-center justify-center border border-white/30">
                                                <span className="text-xl font-black text-white leading-none">{new Date(selectedDayRecord.date + "T00:00:00").getDate()}</span>
                                                <span className="text-xs font-bold text-white/80 uppercase">{new Date(selectedDayRecord.date + "T00:00:00").toLocaleDateString('es-MX', { month: 'short' })}</span>
                                            </div>
                                            <div>
                                                <h3 className="text-xl font-black text-white">{unitShort}</h3>
                                                <span className="text-xs font-semibold text-white/80">{STATUS_LABELS[selectedDayRecord.status]}</span>
                                            </div>
                                        </div>
                                        <button onClick={() => setShowDayDetailModal(false)} aria-label="Cerrar" className="w-11 h-11 rounded-xl bg-white/15 backdrop-blur flex items-center justify-center hover:bg-white/25 transition-all">
                                            <X size={20} className="text-white" />
                                        </button>
                                    </div>
                                    {/* Total prominente */}
                                    <div className="relative mt-4 text-right">
                                        <p className="text-3xl font-black text-white">${totalDay.toLocaleString('es-MX', { minimumFractionDigits: 2 })}</p>
                                        <p className="text-xs font-semibold text-white/70 uppercase">Total del día</p>
                                    </div>
                                </div>

                                <div className="p-5 space-y-4">
                                    {/* Horario */}
                                    {(selectedDayRecord.startTime || selectedDayRecord.endTime) && (
                                        <div className="flex items-center justify-between p-3.5 bg-dark-hover rounded-xl">
                                            <div className="flex items-center gap-2.5">
                                                <div className="w-11 h-11 rounded-xl bg-emerald-500/15 flex items-center justify-center">
                                                    <Clock size={16} className="text-emerald-400" />
                                                </div>
                                                <div>
                                                    <p className="text-xs font-bold text-gray-500 uppercase">Horario</p>
                                                    <p className="text-sm font-bold text-white">{selectedDayRecord.startTime || '--:--'} → {selectedDayRecord.endTime || '--:--'}</p>
                                                </div>
                                            </div>
                                            {selectedDayRecord.hoursWorked && (
                                                <span className="text-sm font-black text-emerald-400">{selectedDayRecord.hoursWorked.toFixed(1)}h</span>
                                            )}
                                        </div>
                                    )}

                                    {/* Resumen financiero */}
                                    <div className="grid grid-cols-3 gap-2">
                                        <div className="p-3 bg-dark-hover rounded-xl text-center">
                                            <p className="text-xs font-bold text-blue-400 uppercase mb-0.5">Base</p>
                                            <p className="text-sm font-black text-white">${selectedDayRecord.baseSalary?.toFixed(2) || '0.00'}</p>
                                        </div>
                                        <div className="p-3 bg-dark-hover rounded-xl text-center">
                                            <p className="text-xs font-bold text-amber-400 uppercase mb-0.5">Comisiones</p>
                                            <p className="text-sm font-black text-white">${selectedDayRecord.totalComm?.toFixed(2) || '0.00'}</p>
                                        </div>
                                        <div className="p-3 bg-dark-hover rounded-xl text-center">
                                            <p className="text-xs font-bold text-rose-400 uppercase mb-0.5">Gastos</p>
                                            <p className="text-sm font-black text-white">${selectedDayRecord.totalExp?.toFixed(2) || '0.00'}</p>
                                        </div>
                                    </div>
                                    
                                    {/* Comisiones */}
                                    <div>
                                        <p className="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 flex items-center gap-2">
                                            <Sparkles size={12} className="text-amber-400" />
                                            Comisiones ({selectedDayRecord.commissions?.length || 0})
                                        </p>
                                        {selectedDayRecord.commissions && selectedDayRecord.commissions.length > 0 ? (
                                            <div className="space-y-1.5 max-h-48 overflow-y-auto">
                                                {selectedDayRecord.commissions.map((comm, i) => (
                                                    <div key={i} className="flex items-center justify-between p-3 bg-dark-hover rounded-xl">
                                                        <div className="min-w-0 flex-1">
                                                            <p className="text-xs font-bold text-white truncate">{comm.name ? comm.name.replace(/\s*\(.*?\)\s*$/, '') : 'Comisión'}</p>
                                                            
                                                        </div>
                                                        <span className="text-sm font-black text-emerald-400 flex-shrink-0 ml-3">${parseFloat(comm.amount).toFixed(2)}</span>
                                                    </div>
                                                ))}
                                            </div>
                                        ) : (
                                            <div className="p-4 bg-dark-hover rounded-xl text-center">
                                                <p className="text-xs text-gray-500 font-semibold">Sin comisiones registradas</p>
                                            </div>
                                        )}
                                    </div>
                                    
                                    {/* Gastos */}
                                    {selectedDayRecord.expenses && selectedDayRecord.expenses.length > 0 && (
                                        <div>
                                            <p className="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 flex items-center gap-2">
                                                <CreditCard size={12} className="text-rose-400" />
                                                Gastos ({selectedDayRecord.expenses.length})
                                            </p>
                                            <div className="space-y-1.5">
                                                {selectedDayRecord.expenses.map((exp, i) => (
                                                    <div key={i} className="flex items-center justify-between p-3 bg-dark-hover rounded-xl">
                                                        <p className="text-xs font-bold text-white">{exp.name}</p>
                                                        <span className="text-sm font-black text-rose-400 flex-shrink-0 ml-3">-${parseFloat(exp.amount).toFixed(2)}</span>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                    
                                    {/* Notas */}
                                    {selectedDayRecord.description && (
                                        <div className="p-3 bg-dark-hover rounded-xl">
                                            <p className="text-xs font-bold text-gray-500 uppercase mb-1">Notas</p>
                                            <p className="text-xs text-gray-300">{selectedDayRecord.description}</p>
                                        </div>
                                    )}
                                    
                                    {/* Botones de acción */}
                                    <div className="space-y-2.5 pt-2">
                                        <div className="flex gap-2.5">
                                            <button
                                                onClick={() => {
                                                    setShowDayDetailModal(false);
                                                    setEditingId(selectedDayRecord.id);
                                                    setFormData(selectedDayRecord);
                                                    setReturnTab(activeTab);
                                                    setActiveTab('calendar');
                                                    setViewMode('form');
                                                }}
                                                className="flex-1 py-3.5 bg-gradient-to-r from-blue-500 to-blue-600 rounded-xl text-sm font-black text-white hover:from-blue-600 hover:to-blue-700 transition-all active:scale-95 flex items-center justify-center gap-2 shadow-lg shadow-blue-500/20"
                                            >
                                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                                </svg>
                                                Editar
                                            </button>
                                            <button
                                                onClick={() => {
                                                    setShowDayDetailModal(false);
                                                    const autoUnit = selectedDayRecord.unitType || 'all';
                                                    setSelectedUnitType(autoUnit);
                                                    setSelectedCategory('');
                                                    setTargetRecordDate(selectedDayRecord.date);
                                                    setShowQuickCommissionModal(true);
                                                }}
                                                className="flex-1 py-3.5 bg-gradient-to-r from-emerald-500 to-emerald-600 rounded-xl text-sm font-black text-white hover:from-emerald-600 hover:to-emerald-700 transition-all active:scale-95 flex items-center justify-center gap-2 shadow-lg shadow-emerald-500/20"
                                            >
                                                <Plus size={16} />
                                                Comisión
                                            </button>
                                        </div>
                                        
                                        <button
                                            onClick={() => {
                                                setModalState({
                                                    isOpen: true,
                                                    title: 'Eliminar registro',
                                                    message: `¿Estás seguro de eliminar el registro del ${new Date(selectedDayRecord.date + "T00:00:00").toLocaleDateString('es-MX', { day: 'numeric', month: 'long' })}? Esta acción no se puede deshacer.`,
                                                    confirmText: 'Eliminar registro',
                                                    confirmColor: 'rose',
                                                    onConfirm: () => {
                                                        setRecords(records.filter(r => r.id !== selectedDayRecord.id));
                                                        setShowDayDetailModal(false);
                                                        setSelectedDayRecord(null);
                                                        showToast('Registro eliminado', 'success');
                                                    }
                                                });
                                            }}
                                            className="w-full py-3 bg-dark-hover border border-rose-500/20 rounded-xl text-xs font-bold text-rose-400/80 hover:bg-rose-500/10 hover:border-rose-500/40 transition-all active:scale-95 flex items-center justify-center gap-2"
                                        >
                                            <Trash2 size={14} />
                                            Eliminar Registro
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        );
                    })()}

                    {/* Modal de Perfil de Usuario */}
                    {showUserProfile && (
                        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm z-[55] flex items-start justify-center p-4 pt-6 pb-24 overflow-y-auto animate-fade-in"
                             onClick={() => setShowUserProfile(false)}>
                            <div className="glass-effect rounded-2xl max-w-md w-full my-auto animate-slide-up overflow-hidden"
                                 onClick={(e) => e.stopPropagation()}>
                                
                                {/* Header con gradiente */}
                                <div className="bg-gradient-to-br from-emerald-600 to-emerald-700 p-5 relative overflow-hidden">
                                    <div className="absolute inset-0 bg-gradient-to-br from-white/[0.06] to-transparent"></div>
                                    <div className="absolute -top-8 -right-8 w-28 h-28 bg-white/[0.04] rounded-full"></div>
                                    <div className="relative flex items-center justify-between">
                                        <div className="flex items-center gap-3">
                                            <div className="w-14 h-14 rounded-2xl bg-white/20 backdrop-blur flex items-center justify-center border border-white/30">
                                                <User size={24} className="text-white" />
                                            </div>
                                            <div>
                                                <h3 className="text-lg font-black text-white">{userName || 'Usuario'}</h3>
                                                <p className="text-xs font-semibold text-white/70">{employeeId ? `#${employeeId}` : 'Sin ID'}</p>
                                            </div>
                                        </div>
                                        <button onClick={() => setShowUserProfile(false)} aria-label="Cerrar" className="w-11 h-11 rounded-xl bg-white/15 backdrop-blur flex items-center justify-center hover:bg-white/25">
                                            <X size={20} className="text-white" />
                                        </button>
                                    </div>
                                </div>

                                <div className="p-5">
                                {/* Información del Usuario */}
                                <div className="space-y-3 mb-5">
                                    <div>
                                        <label className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1.5 block">Nombre</label>
                                        <input
                                            type="text"
                                            value={userName}
                                            onChange={(e) => {
                                                setUserName(e.target.value);
                                                safeLocalStorage.setItem('worktracker_userName', e.target.value);
                                            }}
                                            placeholder="Nombre completo"
                                            className="w-full bg-dark-hover border border-dark-border p-3.5 rounded-xl text-sm font-semibold outline-none text-white placeholder-gray-500 hover:border-emerald-500/50"
                                        />
                                    </div>
                                    
                                    <div>
                                        <label className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1.5 block">No. Empleado</label>
                                        <input
                                            type="text"
                                            value={employeeId}
                                            onChange={(e) => {
                                                setEmployeeId(e.target.value);
                                                safeLocalStorage.setItem('worktracker_employeeId', e.target.value);
                                            }}
                                            placeholder="Ej: 15724"
                                            className="w-full bg-dark-hover border border-dark-border p-3.5 rounded-xl text-sm font-semibold outline-none text-white placeholder-gray-500 hover:border-emerald-500/50"
                                        />
                                    </div>
                                </div>

                                <div className="border-t border-dark-border/50 pt-4 space-y-2.5">
                                    {/* Código QR - Configuración */}
                                    <button
                                        onClick={() => {
                                            setShowUserProfile(false);
                                            setShowQRConfigModal(true);
                                        }}
                                        className="w-full glass-effect p-4 rounded-xl flex items-center gap-3 hover:bg-dark-hover transition-all"
                                    >
                                        <div className="w-11 h-11 rounded-xl bg-yellow-500/20 flex items-center justify-center">
                                            <svg className="w-5 h-5 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" />
                                            </svg>
                                        </div>
                                        <div className="flex-1 text-left">
                                            <h4 className="text-sm font-bold text-white">Código QR</h4>
                                            <p className="text-xs text-gray-500 mt-0.5">Configura tu código QR</p>
                                        </div>
                                        <ChevronRight size={18} className="text-gray-500" />
                                    </button>
                                    

                                    
                                    {/* Configuración de Tarifas */}
                                    <button
                                        onClick={() => {
                                            setShowUserProfile(false);
                                            setShowRatesConfig(true);
                                        }}
                                        className="w-full glass-effect p-4 rounded-xl flex items-center gap-3 hover:bg-dark-hover transition-all"
                                    >
                                        <div className="w-11 h-11 rounded-xl bg-blue-500/20 flex items-center justify-center">
                                            <Settings size={20} className="text-blue-400" />
                                        </div>
                                        <div className="flex-1 text-left">
                                            <h4 className="text-sm font-bold text-white">Tarifas</h4>
                                            <p className="text-xs text-gray-500 mt-0.5">Ajusta las tarifas</p>
                                        </div>
                                        <ChevronRight size={18} className="text-gray-500" />
                                    </button>
                                    
                                    {/* Exportar Datos */}
                                    <button
                                        onClick={() => {
                                            setShowUserProfile(false);
                                            setShowExportPeriodModal(true);
                                        }}
                                        className="w-full glass-effect p-4 rounded-xl flex items-center gap-3 hover:bg-dark-hover transition-all"
                                    >
                                        <div className="w-11 h-11 rounded-xl bg-emerald-500/20 flex items-center justify-center">
                                            <Download size={20} className="text-emerald-400" />
                                        </div>
                                        <div className="flex-1 text-left">
                                            <h4 className="text-sm font-bold text-white">Exportar</h4>
                                            <p className="text-xs text-gray-500 mt-0.5">PDF o CSV</p>
                                        </div>
                                        <ChevronRight size={18} className="text-gray-500" />
                                    </button>
                                    
                                    {/* Respaldo y Restauración */}
                                    <button
                                        onClick={() => {
                                            setShowUserProfile(false);
                                            setShowBackupModal(true);
                                        }}
                                        className="w-full glass-effect p-4 rounded-xl flex items-center gap-3 hover:bg-dark-hover transition-all"
                                    >
                                        <div className="w-11 h-11 rounded-xl bg-amber-500/20 flex items-center justify-center">
                                            <Shield size={20} className="text-amber-400" />
                                        </div>
                                        <div className="flex-1 text-left">
                                            <h4 className="text-sm font-bold text-white">Respaldo</h4>
                                            <p className="text-xs text-gray-500 mt-0.5">Guarda tus datos</p>
                                        </div>
                                        <ChevronRight size={18} className="text-gray-500" />
                                    </button>
                                    
                                    {/* Restablecer Datos */}
                                    <button
                                        onClick={() => {
                                            setShowUserProfile(false);
                                            setModalState({
                                                isOpen: true,
                                                type: 'reset',
                                                title: '⚠️ Restablecer Datos',
                                                message: 'Esto eliminará TODOS tus registros y configuración. Esta acción NO se puede deshacer.',
                                                confirmText: 'Eliminar Todo',
                                                confirmColor: 'rose',
                                                onConfirm: () => {
                                                    setRecords([]);
                                                    safeLocalStorage.removeItem('worktracker_records');
                                                    setSelectedRecords([]);
                                                    setIsMultiSelectMode(false);
                                                    showToast('Todos los datos han sido eliminados', 'info');
                                                }
                                            });
                                        }}
                                        disabled={records.length === 0}
                                        className="w-full glass-effect p-4 rounded-xl flex items-center gap-3 hover:bg-rose-500/10 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        <div className="w-11 h-11 rounded-xl bg-rose-500/20 flex items-center justify-center">
                                            <Trash2 size={20} className="text-rose-400" />
                                        </div>
                                        <div className="flex-1 text-left">
                                            <h4 className="text-sm font-bold text-rose-400">Restablecer</h4>
                                            <p className="text-xs text-gray-500 mt-0.5">Eliminar todo</p>
                                        </div>
                                        <ChevronRight size={18} className="text-gray-500" />
                                    </button>
                                    
                                    {/* Información */}
                                    <div className="glass-effect p-4 rounded-xl mt-4">
                                        <h4 className="text-xs font-bold mb-2 flex items-center gap-2 text-gray-400">
                                            <AlertCircle size={14} />
                                            Información
                                        </h4>
                                        <div className="space-y-1 text-xs text-gray-500">
                                            <p><span className="font-bold text-gray-400">Versión:</span> 4.0</p>
                                            <p><span className="font-bold text-gray-400">Registros:</span> {records.length}</p>
                                            <p><span className="font-bold text-gray-400">PWA:</span> Instalable ✓</p>
                                        </div>
                                    </div>
                                </div>
                                </div>
                            </div>
                        </div>
                    )}


                    {/* Modal de Configuración de QR - Solo Perfil de Usuario */}
                    {showQRConfigModal && (
                        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm z-[55] flex items-start justify-center p-4 pt-8 pb-24 overflow-y-auto animate-fade-in"
                             onClick={() => setShowQRConfigModal(false)}>
                            <div className="glass-effect rounded-2xl p-6 max-w-md w-full my-auto animate-slide-up"
                                 onClick={(e) => e.stopPropagation()}>
                                <div className="flex items-center justify-between mb-6">
                                    <h3 className="text-lg font-black text-white flex items-center gap-2">
                                        <svg className="w-5 h-5 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" />
                                        </svg>
                                        Configurar Código QR
                                    </h3>
                                    <button onClick={() => setShowQRConfigModal(false)} className="text-gray-500 hover:text-white">
                                        <X size={24} />
                                    </button>
                                </div>
                                
                                {/* Área de Carga de QR */}
                                <div className="mb-4">
                                    {!qrImage ? (
                                        <div 
                                            onClick={() => fileInputRef.current && fileInputRef.current.click()}
                                            className="border-2 border-dashed border-dark-border rounded-2xl p-12 text-center cursor-pointer hover:border-emerald-500/50 hover:bg-dark-hover/50 transition-all"
                                        >
                                            <div className="flex flex-col items-center gap-3">
                                                <svg className="w-16 h-16 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                                                </svg>
                                                <div>
                                                    <p className="text-lg font-bold text-white mb-1">Sube tu Código QR</p>
                                                    <p className="text-xs text-gray-500">Haz clic para seleccionar una imagen</p>
                                                </div>
                                            </div>
                                            <input
                                                ref={fileInputRef}
                                                type="file"
                                                accept="image/*"
                                                onChange={handleQRImageUpload}
                                                className="hidden"
                                            />
                                        </div>
                                    ) : (
                                        <div className="text-center">
                                            <div className="flex justify-center mb-4">
                                                <div className="bg-white p-4 rounded-2xl shadow-2xl">
                                                    <img src={qrImage} alt="Código QR" className="w-48 h-48 object-contain" />
                                                </div>
                                            </div>
                                            <div className="flex items-center gap-2 justify-center text-emerald-400 mb-4">
                                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                                                </svg>
                                                <p className="text-sm font-bold">QR Configurado Exitosamente</p>
                                            </div>
                                            {/* Botones de gestión - SOLO en sección de Usuario */}
                                            <div className="flex gap-3 justify-center">
                                                <button
                                                    onClick={() => fileInputRef.current && fileInputRef.current.click()}
                                                    className="px-5 py-2.5 bg-blue-500/20 border border-blue-500/40 rounded-xl text-sm font-bold text-blue-400 hover:bg-blue-500/30 transition-all flex items-center gap-2"
                                                >
                                                    <Edit size={16} />
                                                    Cambiar QR
                                                </button>
                                                <button
                                                    onClick={() => {
                                                        removeQRImage();
                                                    }}
                                                    className="px-5 py-2.5 bg-rose-500/20 border border-rose-500/40 rounded-xl text-sm font-bold text-rose-400 hover:bg-rose-500/30 transition-all flex items-center gap-2"
                                                >
                                                    <Trash2 size={16} />
                                                    Eliminar
                                                </button>
                                            </div>
                                            <input
                                                ref={fileInputRef}
                                                type="file"
                                                accept="image/*"
                                                onChange={handleQRImageUpload}
                                                className="hidden"
                                            />
                                        </div>
                                    )}
                                </div>
                                
                                {/* Información */}
                                <div className="p-3 bg-blue-500/10 border border-blue-500/30 rounded-xl">
                                    <p className="text-xs text-blue-400 font-semibold flex items-center gap-2">
                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                        {qrImage ? 'Tu código QR está listo para usar. Cierra este modal para continuar.' : 'Sube tu código QR una vez y úsalo para todas tus comisiones.'}
                                    </p>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Modal de QR y Gestión de Imagen - Solo desde Usuario */}

                    {/* Modal de Comisiones Rápidas - Cuando ya existe registro del día */}
                    {showQuickCommissionModal && (
                        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm z-[55] flex items-start justify-center p-4 pt-8 pb-24 overflow-y-auto animate-fade-in"
                             onClick={() => { setShowQuickCommissionModal(false); setTargetRecordDate(null); }}>
                            <div className={`glass-effect rounded-2xl p-6 w-full max-w-full animate-slide-up transition-all my-auto ${
                                selectedCategory ? 'max-w-2xl' : 'max-w-md'
                            }`}
                                 onClick={(e) => e.stopPropagation()}>
                                <div className="flex items-center justify-between mb-4">
                                    <div>
                                        <h3 className="text-xl font-black text-white flex items-center gap-2">
                                            <svg className="w-6 h-6 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" />
                                            </svg>
                                            Agregar Comisión
                                        </h3>
                                        <p className="text-xs text-gray-500 mt-1 font-semibold">
                                            {targetRecordDate && targetRecordDate !== new Date().toISOString().split('T')[0]
                                                ? `📅 Agregando comisiones al ${new Date(targetRecordDate + "T00:00:00").toLocaleDateString('es-MX', { day: 'numeric', month: 'long' })}`
                                                : '✅ Registro de hoy ya creado - Solo agrega comisiones'
                                            }
                                        </p>
                                    </div>
                                    <button onClick={() => {
                                        setShowQuickCommissionModal(false);
                                        setSelectedCategory(null);
                                        setTargetRecordDate(null);
                                    }} className="text-gray-500 hover:text-white">
                                        <X size={24} />
                                    </button>
                                </div>

                                {/* Código QR para escaneo rápido - CENTRADO */}
                                {qrImage && (
                                    <div className="mb-6 flex flex-col items-center">
                                        <div className="flex justify-center mb-3">
                                            <div 
                                                onClick={() => {
                                                    // Crear modal de ampliación
                                                    const fullscreenModal = document.createElement('div');
                                                    fullscreenModal.className = 'fixed inset-0 bg-black/95 backdrop-blur-md z-[100] flex items-center justify-center p-4 animate-fade-in';
                                                    fullscreenModal.onclick = () => fullscreenModal.remove();
                                                    
                                                    const container = document.createElement('div');
                                                    container.className = 'relative max-w-4xl w-full';
                                                    container.onclick = (e) => e.stopPropagation();
                                                    
                                                    const img = document.createElement('img');
                                                    img.src = qrImage;
                                                    img.alt = 'Código QR Ampliado';
                                                    img.className = 'w-full h-auto rounded-2xl shadow-2xl';
                                                    
                                                    const closeBtn = document.createElement('button');
                                                    closeBtn.className = 'absolute -top-4 -right-4 w-12 h-12 rounded-full bg-white text-gray-900 flex items-center justify-center hover:bg-gray-200 transition-all shadow-xl';
                                                    closeBtn.innerHTML = '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>';
                                                    closeBtn.onclick = () => fullscreenModal.remove();
                                                    
                                                    const hint = document.createElement('div');
                                                    hint.className = 'absolute -bottom-12 left-1/2 -translate-x-1/2 text-white text-sm font-semibold bg-black/50 px-4 py-2 rounded-full';
                                                    hint.textContent = '📱 Toca para cerrar';
                                                    
                                                    container.appendChild(img);
                                                    container.appendChild(closeBtn);
                                                    container.appendChild(hint);
                                                    fullscreenModal.appendChild(container);
                                                    document.body.appendChild(fullscreenModal);
                                                }}
                                                className="bg-white p-3 rounded-2xl shadow-2xl cursor-pointer hover:scale-105 transition-transform group relative"
                                            >
                                                <img src={qrImage} alt="Código QR" className="w-32 h-32 object-contain" />
                                                <div className="absolute inset-0 bg-black/0 group-hover:bg-black/10 rounded-2xl transition-all flex items-center justify-center">
                                                    <div className="opacity-0 group-hover:opacity-100 transition-opacity bg-emerald-500 text-white px-2 py-1 rounded-lg text-xs font-bold">
                                                        🔍 Ver
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <p className="text-xs text-center text-gray-500 font-semibold">Haz clic en el QR para ampliar</p>
                                    </div>
                                )}
                                
                                {/* MEJORA #12: Sugerencias inteligentes de comisiones frecuentes */}
                                {(() => {
                                    const frequentComms = getFrequentCommissions();
                                    if (frequentComms.length > 0) {
                                        return (
                                            <div className="mb-6 p-4 bg-gradient-to-r from-amber-500/10 to-orange-500/10 border border-amber-500/30 rounded-xl">
                                                <div className="flex items-center gap-2 mb-3">
                                                    <svg className="w-5 h-5 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" />
                                                    </svg>
                                                    <p className="text-sm font-bold text-amber-400">⚡ TUS RUTAS FRECUENTES</p>
                                                </div>
                                                <div className="flex gap-2 flex-wrap">
                                                    {frequentComms.map(({ name, count }) => {
                                                        const commData = Object.entries(presetCommissions).find(([category, comms]) => 
                                                            Object.keys(comms).includes(name)
                                                        );
                                                        const amount = commData ? commData[1][name] : 0;
                                                        
                                                        return (
                                                            <button
                                                                key={name}
                                                                onClick={() => setPendingCommission({ name, amount })}
                                                                className="px-3 py-2 bg-amber-500/20 hover:bg-amber-500/30 border border-amber-500/40 rounded-lg text-xs font-bold text-amber-300 hover:text-amber-200 transition-all hover:scale-105 active:scale-95"
                                                            >
                                                                {name.split('(')[0].trim()} • ${amount} <span className="text-xs opacity-75">({count}×)</span>
                                                            </button>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        );
                                    }
                                    return null;
                                })()}
                                
                                {/* Botones de Categoría */}
                                <div className="mb-6">
                                    {/* MEJORA #3: Usar unitType guardado directamente */}
                                    {(() => {
                                        const dateToUse = targetRecordDate || new Date().toISOString().split('T')[0];
                                        const targetRec = records.find(r => r.date === dateToUse);
                                        
                                        // Usar directamente el unitType guardado o detectarlo del nombre de unidad
                                        let autoSelectedUnitType = targetRec?.unitType || 'all';
                                        
                                        // Si no existe unitType guardado, intentar detectarlo del texto (retrocompatibilidad)
                                        if (!targetRec?.unitType && targetRec?.unit) {
                                            const unitText = targetRec.unit.toUpperCase();
                                            if (unitText.includes('CRAFT') || unitText.includes('SPRINT') || unitText.includes('TRANS') || unitText.includes('URVAN')) {
                                                autoSelectedUnitType = 'crafter';
                                            } else if (unitText.includes('LIMOSINA') || unitText.includes('SUBURBAN') || unitText.includes('NAVIGATOR')) {
                                                autoSelectedUnitType = 'navigator';
                                            } else if (unitText.includes('AUTOBUS') || unitText.includes('BUS')) {
                                                autoSelectedUnitType = 'autobus';
                                            }
                                        }
                                        
                                        return (
                                            <>
                                                {targetRec && targetRec.unit && (
                                                    <div className="mb-4 p-3 bg-emerald-500/10 border border-emerald-500/30 rounded-xl">
                                                        <p className="text-xs text-emerald-400 font-semibold flex items-center gap-2">
                                                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                            </svg>
                                                            Unidad del día: {targetRec.unit}
                                                        </p>
                                                    </div>
                                                )}
                                            </>
                                        );
                                    })()}
                                    <div className="flex flex-wrap gap-2 justify-center">
                                        <button
                                            onClick={() => setSelectedCategory('Desde Aeropuerto Cancún')}
                                            className={`px-5 py-2.5 rounded-full text-xs font-bold transition-all ${
                                                selectedCategory === 'Desde Aeropuerto Cancún'
                                                    ? 'bg-gradient-to-r from-emerald-500 to-emerald-600 text-white shadow-lg scale-105'
                                                    : 'bg-dark-hover border-2 border-dark-border text-gray-400 hover:bg-dark-card hover:border-emerald-500/50'
                                            }`}
                                        >
                                            ✈️ APTO CANCÚN
                                        </button>
                                        <button
                                            onClick={() => setSelectedCategory('Desde Aeropuerto Tulúm')}
                                            className={`px-5 py-2.5 rounded-full text-xs font-bold transition-all ${
                                                selectedCategory === 'Desde Aeropuerto Tulúm'
                                                    ? 'bg-gradient-to-r from-purple-500 to-purple-600 text-white shadow-lg scale-105'
                                                    : 'bg-dark-hover border-2 border-dark-border text-gray-400 hover:bg-dark-card hover:border-purple-500/50'
                                            }`}
                                        >
                                            ✈️ APTO TULÚM
                                        </button>
                                        <button
                                            onClick={() => setSelectedCategory('Punto a Punto')}
                                            className={`px-5 py-2.5 rounded-full text-xs font-bold transition-all ${
                                                selectedCategory === 'Punto a Punto'
                                                    ? 'bg-gradient-to-r from-blue-500 to-blue-600 text-white shadow-lg scale-105'
                                                    : 'bg-dark-hover border-2 border-dark-border text-gray-400 hover:bg-dark-card hover:border-blue-500/50'
                                            }`}
                                        >
                                            🔄 PUNTO A PUNTO
                                        </button>
                                        <button
                                            onClick={() => setSelectedCategory('Servicios Especiales')}
                                            className={`px-5 py-2.5 rounded-full text-xs font-bold transition-all ${
                                                selectedCategory === 'Servicios Especiales'
                                                    ? 'bg-gradient-to-r from-amber-500 to-amber-600 text-white shadow-lg scale-105'
                                                    : 'bg-dark-hover border-2 border-dark-border text-gray-400 hover:bg-dark-card hover:border-amber-500/50'
                                            }`}
                                        >
                                            ⭐ ESPECIALES
                                        </button>
                                    </div>
                                </div>
                                
                                {/* Lista de Comisiones - Solo se muestra si hay categoría seleccionada */}
                                {selectedCategory ? (
                                    <div className="space-y-2">
                                        <h4 className="text-sm font-bold text-emerald-400 mb-3 uppercase tracking-wider">
                                            {selectedCategory}
                                        </h4>
                                        {Object.entries(getFilteredCommissionsByCategory(selectedCategory, selectedUnitType)).length === 0 ? (
                                            <div className="text-center py-12">
                                                <Sparkles size={48} className="text-gray-600 mx-auto mb-3" />
                                                <p className="text-gray-500 text-sm font-semibold">No hay comisiones disponibles</p>
                                                <p className="text-gray-600 text-xs mt-1">Selecciona otro tipo de unidad o categoría</p>
                                            </div>
                                        ) : (
                                            Object.entries(getFilteredCommissionsByCategory(selectedCategory, selectedUnitType)).map(([name, amount]) => {
                                                const parts = name.match(/^(.+?)\s*\((.+?)\)$/);
                                                const destination = parts ? parts[1].trim() : name;
                                                const vehicleType = parts ? parts[2].trim() : '';
                                                
                                                return (
                                                    <button
                                                        key={name}
                                                        onClick={() => setPendingCommission({ name, amount })}
                                                        className="w-full p-4 rounded-xl bg-dark-card hover:bg-dark-hover border-2 border-dark-border hover:border-emerald-500/50 transition-all group"
                                                    >
                                                    <div className="flex items-center justify-between">
                                                        <div className="text-left flex-1">
                                                            <p className="text-sm font-black text-white group-hover:text-emerald-400 transition-colors mb-1">
                                                                {destination}
                                                            </p>
                                                            {vehicleType && (
                                                                <p className="text-xs font-semibold text-gray-500">
                                                                    ({vehicleType})
                                                                </p>
                                                            )}
                                                        </div>
                                                        <div className="text-right ml-4">
                                                            <p className="text-2xl font-black text-emerald-400">
                                                                ${amount}
                                                            </p>
                                                        </div>
                                                    </div>
                                                </button>
                                            );
                                        })
                                    )}
                                </div>
                                ) : (
                                    <div className="text-center py-12">
                                        <svg className="w-16 h-16 text-gray-600 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" />
                                        </svg>
                                        <p className="text-gray-500 text-sm font-semibold">Selecciona una categoría</p>
                                        <p className="text-gray-600 text-xs mt-1">Elige APTO Cancún, Punto a Punto o APTO Tulúm</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* Modales de Configuración */}
                    
                    
                    {/* Modal de Comisiones Preconfiguradas */}
                    {showCommissionsModal && (
                        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm z-[55] flex items-start justify-center p-4 pt-8 pb-24 overflow-y-auto animate-fade-in"
                             onClick={() => setShowCommissionsModal(false)}>
                            <div className="glass-effect rounded-2xl p-6 max-w-2xl w-full my-auto animate-slide-up"
                                 onClick={(e) => e.stopPropagation()}>
                                <div className="flex items-center justify-between mb-6">
                                    <h3 className="text-lg font-black text-white flex items-center gap-2">
                                        <Sparkles size={20} className="text-blue-400" />
                                        Comisiones Preconfiguradas
                                    </h3>
                                    <button onClick={() => setShowCommissionsModal(false)} className="text-gray-500 hover:text-white">
                                        <X size={24} />
                                    </button>
                                </div>
                                
                                {/* Indicador de filtro activo */}
                                {selectedUnitType !== 'all' && (
                                    <div className="mb-4 p-3 bg-blue-500/20 border border-blue-500/30 rounded-xl">
                                        <p className="text-xs text-blue-400 font-semibold flex items-center gap-2">
                                            <AlertCircle size={14} />
                                            Mostrando solo comisiones para: {
                                                selectedUnitType === 'crafter' ? '🚐 Crafter / Sprinter / Transporter / Urvan' :
                                                selectedUnitType === 'navigator' ? '🚙 Limosina / Suburban / Navigator' :
                                                '🚌 Autobús'
                                            }
                                        </p>
                                    </div>
                                )}
                                
                                {/* Category pills */}
                                <div className="flex flex-wrap gap-2 mb-4">
                                    <button onClick={() => setPreconfFilter('Desde Aeropuerto Cancún')}
                                        className={`px-4 py-2 rounded-full text-xs font-bold transition-all ${
                                            preconfFilter === 'Desde Aeropuerto Cancún' ? 'bg-gradient-to-r from-emerald-500 to-emerald-600 text-white shadow-lg' : 'bg-dark-hover border-2 border-dark-border text-gray-400 hover:border-emerald-500/50'
                                        }`}>✈️ APTO CANCÚN</button>
                                    <button onClick={() => setPreconfFilter('Desde Aeropuerto Tulúm')}
                                        className={`px-4 py-2 rounded-full text-xs font-bold transition-all ${
                                            preconfFilter === 'Desde Aeropuerto Tulúm' ? 'bg-gradient-to-r from-purple-500 to-purple-600 text-white shadow-lg' : 'bg-dark-hover border-2 border-dark-border text-gray-400 hover:border-purple-500/50'
                                        }`}>✈️ APTO TULÚM</button>
                                    <button onClick={() => setPreconfFilter('Punto a Punto')}
                                        className={`px-4 py-2 rounded-full text-xs font-bold transition-all ${
                                            preconfFilter === 'Punto a Punto' ? 'bg-gradient-to-r from-blue-500 to-blue-600 text-white shadow-lg' : 'bg-dark-hover border-2 border-dark-border text-gray-400 hover:border-blue-500/50'
                                        }`}>🔄 PUNTO A PUNTO</button>
                                    <button onClick={() => setPreconfFilter('Servicios Especiales')}
                                        className={`px-4 py-2 rounded-full text-xs font-bold transition-all ${
                                            preconfFilter === 'Servicios Especiales' ? 'bg-gradient-to-r from-amber-500 to-amber-600 text-white shadow-lg' : 'bg-dark-hover border-2 border-dark-border text-gray-400 hover:border-amber-500/50'
                                        }`}>⭐ ESPECIALES</button>
                                </div>

                                <div className="space-y-4">
                                    {(() => {
                                        const allComms = getFilteredCommissions(selectedUnitType);
                                        const filtered = preconfFilter 
                                            ? Object.fromEntries(Object.entries(allComms).filter(([cat]) => cat === preconfFilter))
                                            : allComms;
                                        return Object.keys(filtered).length === 0 ? (
                                        <div className="text-center py-12">
                                            <Sparkles size={48} className="text-gray-600 mx-auto mb-3" />
                                            <p className="text-gray-500 text-sm font-semibold">No hay comisiones para este tipo de unidad</p>
                                            <p className="text-gray-600 text-xs mt-1">Selecciona "Todas las unidades" para ver todas las opciones</p>
                                        </div>
                                    ) : (
                                        Object.entries(filtered).map(([category, commissions]) => (
                                        <div key={category} className="space-y-3">
                                            <h4 className="text-sm font-bold text-emerald-400 mb-3">{category}</h4>
                                            <div className="space-y-2">
                                                {Object.entries(commissions).map(([name, amount]) => {
                                                    // Separar el nombre del destino y el tipo de vehículo
                                                    const parts = name.match(/^(.+?)\s*\((.+?)\)$/);
                                                    const destination = parts ? parts[1].trim() : name;
                                                    const vehicleType = parts ? parts[2].trim() : '';
                                                    
                                                    return (
                                                        <button
                                                            key={name}
                                                            onClick={() => {
                                                                const newComm = { name, amount: amount.toString() };
                                                                setFormData({
                                                                    ...formData,
                                                                    commissions: [...formData.commissions, newComm]
                                                                });
                                                                setShowCommissionsModal(false);
                                                                showToast(`✓ ${name} agregada`, 'success');
                                                            }}
                                                            className="w-full p-4 rounded-xl bg-dark-card hover:bg-dark-hover border-2 border-dark-border hover:border-emerald-500/50 transition-all group"
                                                        >
                                                            <div className="flex items-center justify-between">
                                                                <div className="text-left flex-1">
                                                                    <p className="text-base font-black text-white group-hover:text-emerald-400 transition-colors mb-1">
                                                                        {destination}
                                                                    </p>
                                                                    {vehicleType && (
                                                                        <p className="text-xs font-semibold text-gray-500">
                                                                            ({vehicleType})
                                                                        </p>
                                                                    )}
                                                                </div>
                                                                <div className="text-right ml-4">
                                                                    <p className="text-3xl font-black text-emerald-400">
                                                                        ${amount}
                                                                    </p>
                                                                </div>
                                                            </div>
                                                        </button>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    ))
                                    );
                                    })()}
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Modal de QR con Comisiones */}
                    {showQRModal && (
                        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm z-[55] flex items-start justify-center p-4 pt-8 pb-24 overflow-y-auto animate-fade-in"
                             onClick={() => setShowQRModal(false)}>
                            <div className="glass-effect rounded-2xl p-6 w-full max-w-md animate-slide-up my-auto"
                                 onClick={(e) => e.stopPropagation()}>
                                
                                {/* Header */}
                                <div className="flex items-center justify-between mb-6">
                                    <h3 className="text-lg font-black text-white flex items-center gap-2">
                                        <Clock size={20} className="text-emerald-400" />
                                        Registrar Jornada
                                    </h3>
                                    <button onClick={() => setShowQRModal(false)} aria-label="Cerrar" className="text-gray-500 hover:text-white w-11 h-11 flex items-center justify-center">
                                        <X size={24} />
                                    </button>
                                </div>
                                
                                {/* Mensaje principal */}
                                <div className="mb-6 p-4 bg-amber-500/10 border border-amber-500/30 rounded-xl">
                                    <div className="flex items-start gap-3">
                                        <svg className="w-6 h-6 text-amber-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                        <div>
                                            <p className="text-sm font-bold text-amber-400 mb-1">Registra tu día primero</p>
                                            <p className="text-xs text-gray-400">Ingresa tus horarios y tipo de unidad para habilitar el código QR y las comisiones.</p>
                                        </div>
                                    </div>
                                </div>

                                {/* Fecha de Registro */}
                                <div className="mb-5">
                                    <label className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 block flex items-center gap-2">
                                        <Calendar size={14} className="text-emerald-400" />
                                        Fecha de registro
                                    </label>
                                    <input 
                                        type="date" 
                                        value={formData.date || new Date().toISOString().split('T')[0]} 
                                        onChange={e => setFormData({...formData, date: e.target.value})} 
                                        className="w-full bg-dark-hover border-2 border-dark-border p-3 rounded-xl text-sm font-semibold text-white hover:border-emerald-500/50 transition-all"
                                    />
                                </div>

                                {/* Campos de Horario */}
                                <div className="mb-5 space-y-4">
                                    <h4 className="text-sm font-bold text-white uppercase tracking-wider flex items-center gap-2">
                                        <svg className="w-4 h-4 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                        Horario de Trabajo
                                    </h4>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div>
                                            <label className="text-xs font-bold text-gray-400 mb-2 block">Hora Inicio *</label>
                                            <input 
                                                type="time" 
                                                value={formData.startTime} 
                                                onChange={e => {
                                                    const newStartTime = e.target.value;
                                                    let newEndTime = '';
                                                    if (newStartTime) {
                                                        const [hours, minutes] = newStartTime.split(':').map(Number);
                                                        const startDate = new Date(2000, 0, 1, hours, minutes);
                                                        const endDate = new Date(startDate.getTime() + 8 * 60 * 60 * 1000);
                                                        newEndTime = `${String(endDate.getHours()).padStart(2, '0')}:${String(endDate.getMinutes()).padStart(2, '0')}`;
                                                    }
                                                    setFormData({...formData, startTime: newStartTime, endTime: newEndTime});
                                                }} 
                                                className="w-full bg-dark-hover border-2 border-dark-border p-3 rounded-xl text-sm font-semibold text-white hover:border-emerald-500/50 transition-all"
                                                required
                                            />
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold text-gray-400 mb-2 block">Hora Fin *</label>
                                            <input 
                                                type="time" 
                                                value={formData.endTime} 
                                                onChange={e => setFormData({...formData, endTime: e.target.value})} 
                                                className="w-full bg-dark-hover border-2 border-dark-border p-3 rounded-xl text-sm font-semibold text-white hover:border-emerald-500/50 transition-all"
                                                required
                                            />
                                        </div>
                                    </div>
                                    {formData.startTime && formData.endTime && (
                                        (() => {
                                            let hours = (new Date(`2000-01-01T${formData.endTime}`) - new Date(`2000-01-01T${formData.startTime}`)) / (1000 * 60 * 60);
                                            if (hours <= 0) hours += 24;
                                            return (
                                                <div className="p-3 bg-emerald-500/20 border border-emerald-500/30 rounded-xl">
                                                    <p className="text-xs text-emerald-400 font-semibold">
                                                        ⏱️ Horas trabajadas: {hours.toFixed(2)}h {hours > 12 ? '(turno nocturno)' : ''}
                                                    </p>
                                                </div>
                                            );
                                        })()
                                    )}
                                </div>

                                {/* Tipo de Unidad */}
                                <div className="mb-4">
                                    <label className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 block flex items-center gap-2">
                                        <svg className="w-4 h-4 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                                        </svg>
                                        Tipo de Unidad *
                                    </label>
                                    <select 
                                        value={selectedUnitType}
                                        onChange={(e) => setSelectedUnitType(e.target.value)}
                                        className="w-full bg-dark-hover border-2 border-dark-border p-3 rounded-xl text-sm font-semibold text-white hover:border-emerald-500/50 transition-all"
                                        required
                                    >
                                        <option value="" disabled>Selecciona tu tipo de unidad</option>
                                        <option value="crafter">🚐 Crafter / Sprinter / Transporter / Urvan</option>
                                        <option value="navigator">🚙 Limosina / Suburban / Navigator</option>
                                        <option value="autobus">🚌 Autobús</option>
                                    </select>
                                </div>
                                
                                {/* Identificador de Unidad */}
                                <div className="mb-6">
                                    <label className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 block flex items-center gap-2">
                                        <svg className="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14" />
                                        </svg>
                                        Unidad (nombre/número)
                                    </label>
                                    <input 
                                        type="text" 
                                        placeholder="Ej: UV07, Sprinter 3, Bus 12..."
                                        value={unitIdentifier}
                                        onChange={(e) => setUnitIdentifier(e.target.value.toUpperCase())}
                                        maxLength={20}
                                        className="w-full bg-dark-hover border-2 border-dark-border p-3 rounded-xl text-sm font-semibold text-white placeholder-gray-500 hover:border-emerald-500/50 transition-all"
                                    />
                                </div>

                                {/* Botón de Registro */}
                                {formData.startTime && formData.endTime && selectedUnitType ? (
                                    <button
                                        onClick={() => {
                                            const targetDate = formData.date || new Date().toISOString().split('T')[0];
                                            const existingRecord = records.find(r => r.date === targetDate);
                                            if (existingRecord) {
                                                showToast('Ya existe un registro para esa fecha', 'info');
                                                setShowQRModal(false);
                                                return;
                                            }
                                            
                                            const currentRates = getCurrentRates();
                                            
                                            // Auto-detectar día festivo
                                            const isHoliday = HOLIDAYS_2026.find(h => h.date === targetDate);
                                            const effectiveStatus = isHoliday ? 'holiday' : 'worked';
                                            const baseSalary = currentRates[effectiveStatus];
                                            const start = new Date(`2000-01-01T${formData.startTime}`);
                                            const end = new Date(`2000-01-01T${formData.endTime}`);
                                            let hoursWorked = (end - start) / (1000 * 60 * 60);
                                            if (hoursWorked < 0) hoursWorked += 24;
                                            
                                            const unitNames = {
                                                'crafter': 'Crafter/Sprinter/Transporter/Urvan',
                                                'navigator': 'Limosina/Suburban/Navigator',
                                                'autobus': 'Autobús'
                                            };
                                            const baseUnitName = unitNames[selectedUnitType] || selectedUnitType;
                                            const fullUnitName = unitIdentifier ? `${unitIdentifier} - ${baseUnitName}` : baseUnitName;
                                            
                                            const newRecord = {
                                                id: Date.now(),
                                                date: targetDate,
                                                status: effectiveStatus,
                                                unit: fullUnitName,
                                                unitType: selectedUnitType,
                                                startTime: formData.startTime,
                                                endTime: formData.endTime,
                                                commissions: [],
                                                expenses: [],
                                                description: '',
                                                baseSalary,
                                                totalComm: 0,
                                                totalExp: 0,
                                                hoursWorked
                                            };
                                            
                                            setRecords(prev => [...prev, newRecord]);
                                            const successMsg = isHoliday 
                                                ? `✓ Jornada registrada (${isHoliday.name} — tarifa festiva)`
                                                : '✓ Jornada registrada exitosamente';
                                            showToast(successMsg, 'success');
                                            setShowQRModal(false);
                                            setUnitIdentifier('');
                                            
                                            // Transición automática al modal de comisiones rápidas
                                            setTargetRecordDate(targetDate);
                                            setTimeout(() => {
                                                setSelectedCategory('');
                                                setShowQuickCommissionModal(true);
                                            }, 300);
                                        }}
                                        className="w-full py-4 bg-gradient-to-r from-emerald-500 to-emerald-600 rounded-xl text-base font-black text-white hover:from-emerald-600 hover:to-emerald-700 transition-all hover:scale-[1.02] active:scale-95 shadow-lg flex items-center justify-center gap-2"
                                    >
                                        <Check size={20} />
                                        Registrar Jornada y Continuar
                                    </button>
                                ) : (
                                    <div className="w-full py-4 bg-dark-hover rounded-xl text-base font-black text-gray-600 text-center border-2 border-dashed border-dark-border">
                                        Completa los campos para continuar
                                    </div>
                                )}
                                
                                {/* Nota sobre QR */}
                                <div className="mt-4 p-3 bg-blue-500/10 border border-blue-500/30 rounded-xl">
                                    <p className="text-xs text-blue-400 font-semibold flex items-center gap-2">
                                        <svg className="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" />
                                        </svg>
                                        Tu código QR y las comisiones estarán disponibles después de registrar la jornada.
                                    </p>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Modal de Configuración de Tarifas */}
                    {showRatesConfig && (
                        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm z-[55] flex items-start justify-center p-4 pt-8 pb-24 overflow-y-auto animate-fade-in"
                             onClick={() => setShowRatesConfig(false)}>
                            <div className="glass-effect rounded-2xl p-6 max-w-md w-full my-auto animate-slide-up"
                                 onClick={(e) => e.stopPropagation()}>
                                <div className="flex items-center justify-between mb-6">
                                    <h3 className="text-lg font-black text-white flex items-center gap-2">
                                        <Settings size={20} className="text-blue-400" />
                                        Configuración de Tarifas
                                    </h3>
                                    <button onClick={() => setShowRatesConfig(false)} className="text-gray-500 hover:text-white">
                                        <X size={24} />
                                    </button>
                                </div>
                                
                                <div className="space-y-3">
                                    {Object.entries(STATUS_LABELS).map(([key, label]) => {
                                        const currentRates = getCurrentRates();
                                        return (
                                            <div key={key}>
                                                <label className="text-xs font-semibold text-gray-400 mb-1.5 block">
                                                    {label}
                                                </label>
                                                <input
                                                    type="number"
                                                    step="0.01"
                                                    value={customRates ? customRates[key] : RATES[key]}
                                                    onChange={(e) => {
                                                        const newRates = customRates ? {...customRates} : {...RATES};
                                                        newRates[key] = parseFloat(e.target.value) || 0;
                                                        setCustomRates(newRates);
                                                    }}
                                                    className="w-full bg-dark-hover border border-dark-border p-3 rounded-xl text-sm font-bold text-emerald-400 outline-none hover:border-emerald-500/50"
                                                />
                                            </div>
                                        );
                                    })}
                                    <div className="flex gap-3 pt-4">
                                        <button
                                            onClick={() => {
                                                setCustomRates(null);
                                                safeLocalStorage.removeItem('worktracker_rates');
                                                showToast('✓ Tarifas restauradas a valores por defecto', 'success');
                                            }}
                                            className="flex-1 px-4 py-3 bg-dark-hover rounded-xl text-xs font-bold text-gray-400 hover:bg-dark-card transition-all"
                                        >
                                            Restaurar
                                        </button>
                                        <button
                                            onClick={() => {
                                                if (customRates) {
                                                    saveCustomRates(customRates);
                                                    setShowRatesConfig(false);
                                                }
                                            }}
                                            className="flex-1 px-4 py-3 bg-emerald-500 rounded-xl text-xs font-bold text-white hover:bg-emerald-600 transition-all"
                                        >
                                            Guardar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Modal de Respaldo y Restauración */}
                    {showBackupModal && (
                        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm z-[55] flex items-start justify-center p-4 pt-8 pb-24 overflow-y-auto animate-fade-in"
                             onClick={() => setShowBackupModal(false)}>
                            <div className="glass-effect rounded-2xl p-6 max-w-md w-full animate-slide-up"
                                 onClick={(e) => e.stopPropagation()}>
                                <div className="flex items-center justify-between mb-6">
                                    <h3 className="text-lg font-black text-white flex items-center gap-2">
                                        <Shield size={20} className="text-amber-400" />
                                        Respaldo y Restauración
                                    </h3>
                                    <button onClick={() => setShowBackupModal(false)} className="text-gray-500 hover:text-white">
                                        <X size={24} />
                                    </button>
                                </div>
                                
                                <div className="space-y-3">
                                    <button
                                        onClick={() => {
                                            if (records.length === 0) {
                                                showToast('No hay datos para respaldar', 'warning');
                                                return;
                                            }
                                            if (exportBackup(records)) {
                                                showToast('✓ Respaldo creado exitosamente', 'success');
                                            } else {
                                                showToast('Error al crear el respaldo', 'error');
                                            }
                                        }}
                                        className="w-full flex items-center justify-center gap-2 px-4 py-4 bg-blue-500/20 rounded-xl text-sm font-bold text-blue-400 border border-blue-500/30 hover:bg-blue-500/30 transition-all"
                                    >
                                        <Download size={20} /> Exportar Respaldo (JSON)
                                    </button>
                                    <button
                                        onClick={() => fileInputRef.current?.click()}
                                        className="w-full flex items-center justify-center gap-2 px-4 py-4 bg-amber-500/20 rounded-xl text-sm font-bold text-amber-400 border border-amber-500/30 hover:bg-amber-500/30 transition-all"
                                    >
                                        <Upload size={20} /> Importar Respaldo
                                    </button>
                                    <input
                                        ref={fileInputRef}
                                        type="file"
                                        accept=".json"
                                        onChange={(e) => {
                                            const file = e.target.files?.[0];
                                            if (file) {
                                                importBackup(file, setRecords, showToast);
                                            }
                                            e.target.value = '';
                                        }}
                                        className="hidden"
                                    />
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Modal de Exportar Datos */}
                    {showExportPeriodModal && (
                        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm z-[55] flex items-start justify-center p-4 pt-8 pb-24 overflow-y-auto animate-fade-in"
                             onClick={() => setShowExportPeriodModal(false)}>
                            <div className="glass-effect rounded-2xl p-6 max-w-md w-full animate-slide-up"
                                 onClick={(e) => e.stopPropagation()}>
                                <div className="flex items-center justify-between mb-6">
                                    <h3 className="text-lg font-black text-white flex items-center gap-2">
                                        <Download size={20} className="text-emerald-400" />
                                        Exportar Datos
                                    </h3>
                                    <button onClick={() => setShowExportPeriodModal(false)} className="text-gray-500 hover:text-white">
                                        <X size={24} />
                                    </button>
                                </div>
                                
                                <div className="space-y-4">
                                    {/* Periodo selector */}
                                    <div>
                                        <label className="text-xs font-semibold text-gray-400 mb-2 block">Periodo a exportar</label>
                                        <select
                                            value={exportSelectedPeriod}
                                            onChange={e => setExportSelectedPeriod(e.target.value)}
                                            className="w-full bg-dark-hover border border-dark-border p-3 rounded-xl text-sm font-semibold outline-none text-white hover:border-emerald-500/50"
                                        >
                                            <option value="current">📌 Periodo actual ({(() => {
                                                const now = new Date();
                                                const cp = commissionPeriods.find(p => now >= p.startDate && now <= p.endDate);
                                                return cp ? cp.label : 'N/A';
                                            })()})</option>
                                            {commissionPeriods.map((p, i) => (
                                                <option key={i} value={p.label}>
                                                    {p.label} — Cobro: día {p.payDay.getDate()}
                                                </option>
                                            ))}
                                        </select>
                                    </div>

                                    {/* Preview */}
                                    {(() => {
                                        const now = new Date();
                                        const exportPeriod = exportSelectedPeriod === 'current'
                                            ? commissionPeriods.find(p => now >= p.startDate && now <= p.endDate)
                                            : commissionPeriods.find(p => p.label === exportSelectedPeriod);
                                        const exportRecords = exportPeriod
                                            ? records.filter(r => {
                                                const d = new Date(r.date + "T00:00:00");
                                                return d >= exportPeriod.startDate && d <= exportPeriod.endDate;
                                            })
                                            : filteredRecords;
                                        const exportLabel = exportPeriod ? exportPeriod.label : 'Personalizado';
                                        const expTotals = {
                                            total: exportRecords.reduce((s, r) => s + (r.baseSalary||0) + (r.totalComm||0) - (r.totalExp||0), 0),
                                            worked: exportRecords.reduce((s, r) => s + (r.baseSalary||0), 0),
                                            commissions: exportRecords.reduce((s, r) => s + (r.totalComm||0), 0),
                                            expenses: exportRecords.reduce((s, r) => s + (r.totalExp||0), 0)
                                        };
                                        
                                        return (
                                            <>
                                                <div className="p-3 bg-dark-hover rounded-xl flex items-center justify-between">
                                                    <span className="text-xs font-bold text-gray-400">{exportRecords.length} registros</span>
                                                    <span className="text-sm font-black text-emerald-400">${expTotals.total.toLocaleString('es-MX', {minimumFractionDigits: 2})}</span>
                                                </div>

                                                {/* Format buttons */}
                                                <div>
                                                    <label className="text-xs font-semibold text-gray-400 mb-2 block">Formato</label>
                                                    <div className="grid grid-cols-2 gap-3">
                                                        <button
                                                            onClick={() => {
                                                                if (exportRecords.length === 0) { showToast('No hay registros para exportar', 'warning'); return; }
                                                                if (exportToPDF(exportRecords, expTotals, exportLabel, exportSalary, exportCommissions, exportExpenses, userName, employeeId)) {
                                                                    showToast('✓ PDF exportado', 'success');
                                                                    setShowExportPeriodModal(false);
                                                                }
                                                            }}
                                                            className="flex flex-col items-center gap-2 p-4 bg-rose-500/20 rounded-xl text-sm font-bold text-rose-400 border border-rose-500/30 hover:bg-rose-500/30 transition-all"
                                                        >
                                                            <FileText size={24} />
                                                            <span>PDF</span>
                                                        </button>
                                                        <button
                                                            onClick={() => {
                                                                if (exportRecords.length === 0) { showToast('No hay registros para exportar', 'warning'); return; }
                                                                if (exportToCSV(exportRecords, exportLabel, exportSalary, exportCommissions, exportExpenses, userName, employeeId)) {
                                                                    showToast('✓ CSV exportado', 'success');
                                                                    setShowExportPeriodModal(false);
                                                                }
                                                            }}
                                                            className="flex flex-col items-center gap-2 p-4 bg-emerald-500/20 rounded-xl text-sm font-bold text-emerald-400 border border-emerald-500/30 hover:bg-emerald-500/30 transition-all"
                                                        >
                                                            <FileText size={24} />
                                                            <span>CSV</span>
                                                        </button>
                                                    </div>
                                                </div>
                                            </>
                                        );
                                    })()}
                                    
                                    <div className="border-t border-dark-border pt-4">
                                        <label className="text-xs font-semibold text-gray-400 mb-3 block">¿Qué incluir en la exportación?</label>
                                        <div className="space-y-2">
                                            <label className="flex items-center gap-3 p-3 rounded-xl bg-dark-hover cursor-pointer hover:bg-dark-card transition-all">
                                                <input
                                                    type="checkbox"
                                                    checked={exportSalary}
                                                    onChange={(e) => setExportSalary(e.target.checked)}
                                                    className="w-5 h-5 rounded border-2 border-dark-border bg-dark-bg checked:bg-emerald-500 checked:border-emerald-500 cursor-pointer"
                                                />
                                                <span className="text-sm font-semibold text-white">Salarios</span>
                                            </label>
                                            <label className="flex items-center gap-3 p-3 rounded-xl bg-dark-hover cursor-pointer hover:bg-dark-card transition-all">
                                                <input
                                                    type="checkbox"
                                                    checked={exportCommissions}
                                                    onChange={(e) => setExportCommissions(e.target.checked)}
                                                    className="w-5 h-5 rounded border-2 border-dark-border bg-dark-bg checked:bg-emerald-500 checked:border-emerald-500 cursor-pointer"
                                                />
                                                <span className="text-sm font-semibold text-white">Comisiones</span>
                                            </label>
                                            <label className="flex items-center gap-3 p-3 rounded-xl bg-dark-hover cursor-pointer hover:bg-dark-card transition-all">
                                                <input
                                                    type="checkbox"
                                                    checked={exportExpenses}
                                                    onChange={(e) => setExportExpenses(e.target.checked)}
                                                    className="w-5 h-5 rounded border-2 border-dark-border bg-dark-bg checked:bg-emerald-500 checked:border-emerald-500 cursor-pointer"
                                                />
                                                <span className="text-sm font-semibold text-white">Gastos</span>
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div className="text-xs text-gray-500 bg-blue-500/10 border border-blue-500/30 rounded-xl p-3">
                                        <p className="flex items-center gap-2 text-blue-400 font-semibold">
                                            <AlertCircle size={14} />
                                            Información
                                        </p>
                                        <p className="mt-1">Se exportarán {filteredRecords.length} registro{filteredRecords.length !== 1 ? 's' : ''} del período seleccionado.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Modal de Confirmación de Comisión */}
                    {pendingCommission && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[60] flex items-center justify-center p-6 animate-fade-in"
                             onClick={() => setPendingCommission(null)}>
                            <div className="glass-effect rounded-2xl max-w-sm w-full animate-slide-up shadow-2xl overflow-hidden"
                                 onClick={(e) => e.stopPropagation()}>
                                {/* Header verde */}
                                <div className="bg-gradient-to-br from-emerald-500 to-emerald-600 p-5 text-center relative overflow-hidden">
                                    <div className="absolute inset-0 bg-gradient-to-br from-white/[0.08] to-transparent"></div>
                                    <div className="absolute -top-6 -right-6 w-24 h-24 bg-white/[0.05] rounded-full"></div>
                                    <div className="relative">
                                        <div className="w-14 h-14 mx-auto mb-3 rounded-2xl bg-white/20 backdrop-blur flex items-center justify-center border border-white/30">
                                            <Sparkles size={28} className="text-white" />
                                        </div>
                                        <h3 className="text-lg font-black text-white">¿Agregar comisión?</h3>
                                    </div>
                                </div>
                                <div className="p-5">
                                    <div className="p-4 bg-dark-hover rounded-xl mb-5 text-center">
                                        <p className="text-sm font-bold text-white mb-2">{pendingCommission.name.split('(')[0].trim()}</p>
                                        <p className="text-3xl font-black text-emerald-400">${pendingCommission.amount}</p>
                                    </div>
                                    <div className="flex gap-2.5">
                                        <button
                                            onClick={() => setPendingCommission(null)}
                                            className="flex-1 py-3.5 bg-dark-hover border border-dark-border rounded-xl text-sm font-bold text-gray-400 hover:bg-dark-card transition-all active:scale-95"
                                        >
                                            Cancelar
                                        </button>
                                        <button
                                            onClick={confirmAddCommission}
                                            className="flex-1 py-3.5 bg-gradient-to-r from-emerald-500 to-emerald-600 rounded-xl text-sm font-black text-white hover:from-emerald-600 hover:to-emerald-700 transition-all active:scale-95 flex items-center justify-center gap-2 shadow-lg shadow-emerald-500/20"
                                        >
                                            <Check size={18} />
                                            Confirmar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Navegación Inferior */}
                    <nav className={`fixed bottom-0 left-0 right-0 h-20 z-50 border-t ${systemThemeMode === 'light' ? 'border-gray-200' : 'border-white/[0.06]'}`} style={{background: systemThemeMode === 'light' ? 'linear-gradient(to top, rgba(255,255,255,0.98), rgba(248,250,252,0.95))' : 'linear-gradient(to top, rgba(8,8,8,0.99), rgba(10,10,10,0.95))', backdropFilter: 'blur(20px)', WebkitBackdropFilter: 'blur(20px)'}}>
                        <div className="h-full flex justify-around items-center px-4 max-w-md mx-auto">
                        <button 
                            onClick={() => setActiveTab('dashboard')} 
                            className={`flex flex-col items-center gap-1 flex-1 transition-all group ${activeTab === 'dashboard' ? 'text-emerald-400' : 'text-gray-600'}`}
                        >
                           <div className={`w-12 h-10 rounded-xl flex items-center justify-center transition-all relative ${activeTab === 'dashboard' ? 'bg-emerald-500/20 scale-110' : 'group-hover:bg-dark-hover'}`}>
                               <LayoutDashboard size={22} />
                               {activeTab === 'dashboard' && <div className="absolute -bottom-1 w-5 h-0.5 rounded-full bg-emerald-400"></div>}
                           </div>
                           <span className={`text-xs font-bold uppercase tracking-wider ${activeTab === 'dashboard' ? 'text-emerald-400' : ''}`}>Resumen</span>
                        </button>
                        
                        {/* Botón Central + */}
                        {!(activeTab === 'calendar' && viewMode === 'form') && (
                            <button 
                                onClick={() => {
                                    const today = new Date().toISOString().split('T')[0];
                                    const todayRecord = records.find(r => r.date === today);
                                    
                                    if (todayRecord) {
                                        // Ya existe registro de hoy → captura rápida de comisiones
                                        setSelectedCategory('');
                                        setTargetRecordDate(null);
                                        const autoUnit = todayRecord.unitType || (() => {
                                            const unitText = (todayRecord.unit || '').toUpperCase();
                                            if (unitText.includes('CRAFT') || unitText.includes('SPRINT') || unitText.includes('TRANS') || unitText.includes('URVAN')) return 'crafter';
                                            if (unitText.includes('LIMOSINA') || unitText.includes('SUBURBAN') || unitText.includes('NAVIGATOR')) return 'navigator';
                                            if (unitText.includes('AUTOBUS') || unitText.includes('BUS')) return 'autobus';
                                            return 'all';
                                        })();
                                        setSelectedUnitType(autoUnit);
                                        setShowQuickCommissionModal(true);
                                    } else {
                                        // No existe registro de hoy → abrir modal de registro de jornada
                                        setSelectedUnitType('');
                                        setSelectedCategory('');
                                        setUnitIdentifier('');
                                        setFormData(prev => ({...initialFormData, date: new Date().toISOString().split('T')[0]}));
                                        setShowQRModal(true);
                                    }
                                }} 
                                className="flex-shrink-0 -mt-8"
                            >
                                <div className="w-16 h-16 rounded-full bg-gradient-to-br from-emerald-500 to-emerald-600 shadow-2xl shadow-emerald-500/30 flex items-center justify-center hover:scale-110 transition-transform active:scale-95 ring-4 ring-dark-bg">
                                    <Plus size={32} className="text-white" strokeWidth={3} />
                                </div>
                            </button>
                        )}
                        
                        <button 
                            onClick={() => {
                                setActiveTab('history');
                                setIsMultiSelectMode(false);
                                setSelectedRecords([]);
                                setFilterCommissionsOnly(false);
                                setFilterExpensesOnly(false);
                            }} 
                            className={`flex flex-col items-center gap-1 flex-1 transition-all group ${activeTab === 'history' ? 'text-emerald-400' : 'text-gray-600'}`}
                        >
                           <div className={`w-12 h-10 rounded-xl flex items-center justify-center transition-all relative ${activeTab === 'history' ? 'bg-emerald-500/20 scale-110' : 'group-hover:bg-dark-hover'}`}>
                               <HistoryIcon size={22} />
                               {activeTab === 'history' && <div className="absolute -bottom-1 w-5 h-0.5 rounded-full bg-emerald-400"></div>}
                           </div>
                           <span className={`text-xs font-bold uppercase tracking-wider ${activeTab === 'history' ? 'text-emerald-400' : ''}`}>Historial</span>
                        </button>
                        </div>
                    </nav>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

        // Registrar Service Worker para PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(reg => console.log('Service Worker registrado:', reg.scope))
                    .catch(err => console.log('Error al registrar Service Worker:', err));
            });
        }
    </script>
</body>
</html>
